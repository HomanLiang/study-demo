[toc]



# ElasticSearch 入门简介

## 1.简介

ElasticSearch是一个基于Lucene的搜索服务器。它提供了一个分布式多用户能力的全文搜索引擎，基于RESTful web接口。Elasticsearch是用Java开发的，并作为Apache许可条款下的开放源码发布，是当前流行的企业级搜索引擎。设计用于云计算中，能够达到实时搜索，稳定，可靠，快速，安装使用方便。

比较笼统，可以更加直观地描述：

- 分布式的实时文件存储，每个字段都被索引并可被搜索
- 分布式的实时分析搜索引擎
- 可以扩展到上百台服务器，处理PB级结构化或非结构化数据

其实只要知道这几个关键字：**分布式** **实时** **搜索引擎**



## 2.核心概念

### 2.1.ES 与 MySQL 术语对比

ES 是一个搜索引擎，同时它也是一个分布式文档存储数据库（非关系型）。下面对比传统的关系型数据库 MySQL 介绍在 ES 中的一些术语。

在 MySQL 中共有数据库（Database）、表（Table）、记录（Row）、列（Column）的概念，同样在 ES 中也有类似的概念，索引（Index）、类型（Type）、文档（Document）、字段（Field）。

可以这么理解：

![image-20210220220509908](https://homan-blog.oss-cn-beijing.aliyuncs.com/study-demo/elastic-search-demo/image-20210220220509908.png)

### 2.2.索引 Index

ES 中的索引概念可不是关系型数据库中的“索引”，ES 中的索引指的是存储数据的地方，类似关系型数据库中的数据库概念。

### 2.3.类型 Type

有的文章指出 ES 中的类型 Type 对应的就是关系型数据库中的表，在使用 ES 中我们会遇到另外一个概念映射（Mapping），也有不少的文章指出 Mapping 对应的就是关系型数据库中的表。（6.x版本不允许一个索引Index 创建多个 Type，7.x 版本已经移除）

如果一定要理解 ES 中的 Type，那么一定要和 Mapping 结合起来。可以理解为类型 Type 就是定义一个表，仅仅是定义而已，而映射 Mapping 定义了表结构（有哪些列，列的类型是什么）

### 2.4.文档 Document

在非关系数据库中，有部分被称之为 “文档数据库”，对应于关系型数据库中的一行记录。

### 2.5.字段 Field

对应关系型数据库中的列

### 2.6.节点

一个 ES 实例称之为一个节点，单机部署的 ES 有且只有一个节点，集群部署的 ES 有多个节点且有一个主节点。

###  2.7.分片

ES 可作为分布式集群部署，同样也可以作为单机单节点部署。ES 中的数据被分散存储在分片中，ES 屏蔽了底层的分片实现，我们直接与索引交互而不与分片交互。分片数量的多少与是否是集群部署和单机部署无关，即使是单机部署在创建索引时仍然也可以指定划分多个分片（默认 5 个主分片 1份备份（包含 5 个备分片）。分片有主分片和备分片之分，顾名思义，备分片是主分片的备份，当主分片出现故障时，备份片充当主分片。

**对于单机部署**

单机部署的ES，即表示ES有且只有一个节点，在创建索引时，如果不指定主分片与备分片的数量，默认创建 5 个主分片 1份备份（包含 5 个备分片），实际上对于单机部署的ES服务来讲，多个主分片并没有意义的，多个分片存在的意义本身就是将数据分散存储到多个ES节点中进行同时查询，此时只有一个节点多个分片也没有意义。备分片在单机部署中同样也没有意义，备份存在的意义本身就是当主分片故障时，仍然能对外提供服务，此时主备都在同一个节点上，如果主分片故障，备分片也同样会导致故障。

**对于集群部署**

对于集群部署的ES来讲，此时存在多个节点，主分片的分配与备分片机制就显得尤为重要（这涉及查询性能以及服务高可用），例如现在有3个节点，此时如果在创建索引时只分配1个主分片就显得有点浪费（注：主分片一旦在创建索引时确定便不能修改）。主分片的划分并没有一定放之四海而皆准的规则，更多的是取决于用户的数据量以及ES节点数量等。通常所理解的是，分片数量越多越好，因为这能将数据分散到不同分片，以便以后在扩容新增节点时，ES能将自动将分片重新进行均匀分布。但这条理论也不是绝对，如果你的节点只有3个，设置了100个分片，每个节点就有33个分片，当搜索请求调度到同一节点的不同分片时，此时会引发硬件资源（CPU）的抢夺，造成性能问题。反过来，如果3个节点只分配了3个分片，随着业务的发展，数据量越来越大，单个分片已不能承受它最大的数据量，此时就算新增节点，但是分片数量只有3个，分片的数量在创建索引时便确定不可修改，此时只能通过重新创建索引。

既要对合理的数据增长有一个判断（规划较大的分片），又要对期待有一个度的把握（合理的分片数量）。官方给出了一点建议，每个分片的数据量最好是在20G~40G左右，这就意味着如果你有4个节点，数据量预估在200G左右甚至更大，此时分片数量设置为5~10个比较合适，7、8个差不多，每个节点有2个分片。（[我在 Elasticsearch 集群内应该设置多少个分片？](https://www.elastic.co/cn/blog/how-many-shards-should-i-have-in-my-elasticsearch-cluster)）

上面谈到的是主分片，备分片的划分也同等重要。如果不对分片备份，主分片故障则导致数据丢失，部分数据不可查询。副本分片设置过多造成额外的存储空间，默认情况下，创建索引时会创建一个分片副本（一个分片副本不代表一个备分片，如果有5个主分片，那么分片副本就有5个备分片，同理如果指定创建2个分片副本，此时一共就有10个备分片。）需要注意的是备分片是可以修改的，所以备分片可以直接采用默认一个分片副本。



## 3.Elasticsearch主分片不可以修改的原因

Elasticsearch中，一个index一般会有多个主分片(Primary shard)，每个主分片存储该索引的一部分数据，一个文档(document)数据，只会在其中一个分片上，所有主分片的文档合并在一起就是整个索引的数据。而每个主分片都会有副本分片（Replica shard）,用作数据备份，实现高可用以及提供读功能，当出现高并发大量读请求时，通过协调节点负载均衡，减小服务器压力。

这里假设一个index有3个Primary shard(P0,P1,P2)和1个Replica shard(R0,R1,R2)，所以总分片数是：`3+3*1=6`，
**应用程序对es发出写文档请求**：

![20191006105420176](https://homan-blog.oss-cn-beijing.aliyuncs.com/study-demo/elastic-search-demo/20191006105420176.png)

从图里可以很直观的看到，由于索引对文档的增删改操作不会直接作用到备份分片，而是先修改主分片，然后再把修改点同步到备份分片上，所以id为3的文档被路由到了P0，id为1的文档被路由到了P1，id为2的文档被路由到了P2。

这里是通过路由算法：`shard=hash(routing)%number_of_primary_shards` 来计算出文档应该被路由到哪个主分片上

routing的值默认是文档的_id值，可以手动指定，也可以自动生成，特别强调，相同的routing值，每次hash(routing)时，值都是相同的。

`number_of_primary_shards`就是创建索引时指定的主分片数量，7.x前默认是5个主分片，7.x后是1个主分片，当然也可以自己手动设置分片数。

比如上图的_id为1的文档，通过路由算法，假设hash(routing)的值是1，`1%3=1`，所以这个文档被路由到分片一(P1)中。

**读documet的路由图：**

![20191006111456935](https://homan-blog.oss-cn-beijing.aliyuncs.com/study-demo/elastic-search-demo/20191006111456935.png)


从图里可以看出，应用程序要得到_id为3的document，通过路由算法，可以知道P0和R0都可以提供这个文档，具体这次请求由哪个分片处理，则由协调节点通过负载均衡轮询来决定

**协调节点：**上面的两张图都忽略了协调节点的图解，所以这里解释下协调节点。这里请求发到哪个节点上哪个节点就是协调节点，每次请求发到的节点可能都不同，一般情况下，人人都可以是协调节点，每个节点都知道其他节点的信息，所以协调节点在收到请求后能知道这个文档应该去哪个节点里的哪个分片做增删改查操作，但是增删改只能操作主分片，然后通过负载均衡轮询，找到一个分片，处理这个请求，分片会把查请求得到的数据或者增删改的响应发回给协调节点，由协调节点统合，然后响应给客户端。

知道了document的路由原理之后，就可以知道为什么Primary shard不可以修改了，假设我们在上面的3个主分片的基础上又加了一个主分片：

![20191006113732403](https://homan-blog.oss-cn-beijing.aliyuncs.com/study-demo/elastic-search-demo/20191006113732403.png)


之前_id为3的文档是路由到P0和R0分片的，但是加了个主分片后，该文档被路由到P3和R3了，这样就间接的导致了数据丢失，所以主分片数量不能修改，当然了，备份分片数是可以修改的，因为备份分片和路由算法无关哈。

这里有一个问题，之前我觉得要是新增主分片的话，es把数据平均分配不就可以了，然后查了下，原因是分片的切分成本和重新建立索引的成本差不多，所以官方干脆建议直接reindex。

## 4.使用场景

### 4.1.场景—：使用Elasticsearch作为主要的后端

传统项目中，搜索引擎是部署在成熟的数据存储的顶部，以提供快速且相关的搜索能力。这是因为早期的搜索引擎不能提供耐用的存储或其他经常需要的功能，如统计。

![B574B09A-1A75-47e3-ABB9-D2541376435D.png](https://homan-blog.oss-cn-beijing.aliyuncs.com/study-demo/elastic-search-demo/20210503225022.png)

Elasticsearch是提供持久存储、统计等多项功能的现代搜索引擎。 

如果你开始一个新项目，我们建议您考虑使用Elasticsearch作为唯一的数据存储，以帮助保持你的设计尽可能简单。 

此种场景不支持包含频繁更新、事务（transaction）的操作。

举例如下：新建一个博客系统使用es作为存储。

> 1）我们可以向ES提交新的博文； 
> 2）使用ES检索、搜索、统计数据。

ES作为存储的优势： 

如果一台服务器出现故障时会发生什么？你可以通过复制 数据到不同的服务器以达到容错的目的。 

注意： 整体架构设计时，需要我们权衡是否有必要增加额外的存储。

### 4.2.场景二：在现有系统中增加elasticsearch

由于ES不能提供存储的所有功能，一些场景下需要在现有系统数据存储的基础上新增ES支持。

![7ADEA68B-3D99-4f8d-B1DF-A9A03BF0244F.png](https://homan-blog.oss-cn-beijing.aliyuncs.com/study-demo/elastic-search-demo/20210503225057.png)

> 举例1：ES不支持事务、复杂的关系（至少1.X版本不支持，2.X有改善，但支持的仍然不好），如果你的系统中需要上述特征的支持，需要考虑在原有架构、原有存储的基础上的新增ES的支持。

> 举例2：如果你已经有一个在运行的复杂的系统，你的需求之一是在现有系统中添加检索服务。一种非常冒险的方式是重构系统以支持ES。而相对安全的方式是：将ES作为新的组件添加到现有系统中。

如果你使用了如下图所示的SQL数据库和ES存储，你需要找到一种方式使得两存储之间实时同步。需要根据数据的组成、数据库选择对应的同步插件。可供选择的插件包括：

```
1）mysql、oracle选择 logstash-input-jdbc 插件。 
2）mongo选择 mongo-connector工具。
```

假设你的在线零售商店的产品信息存储在SQL数据库中。 为了快速且相关的搜索，你安装Elasticsearch。

为了索引数据，您需要部署一个同步机制，该同步机制可以是Elasticsearch插件或你建立一个自定义的服务。此同步机制可以将对应于每个产品的所有数据和索引都存储在Elasticsearch，每个产品作为一个document存储（这里的document相当于关系型数据库中的一行/row数据）。

当在该网页上的搜索条件中输入“用户的类型”，店面网络应用程序通过Elasticsearch查询该信息。 Elasticsearch返回符合标准的产品documents，并根据你喜欢的方式来分类文档。 排序可以根据每个产品的被搜索次数所得到的相关分数，或任何存储在产品document信息，例如：最新最近加入的产品、平均得分，或者是那些插入或更新信息。 所以你可以只使用Elasticsearch处理搜索。这取决于同步机制来保持Elasticsearch获取最新变化。

### 4.3.场景三：使用elasticsearch和现有的工具

在一些使用情况下，您不必写一行代码就能通过elasticssearch完成一项工作。很多工具都可以与Elasticsearch一起工作，所以你不必到你从头开始编写。

例如，假设要部署一个大规模的日志框架存储，搜索，并分析了大量的事件。 

如图下图，处理日志和输出到Elasticsearch，您可以使用日志记录工具，如rsyslog（www.rsyslog.com），Logstash（www.elastic.co/products/logstash），或Apache Flume（[http://flume.apache.org](http://flume.apache.org/)）。 

搜索和可视化界面分析这些日志，你可以使用Kibana（www.elastic.co/产品/ kibana）。 

![884A06BD-6B62-4a13-9C45-1DB7C6C39587.png](https://homan-blog.oss-cn-beijing.aliyuncs.com/study-demo/elastic-search-demo/20210503225126.png)

**为什么那么多工具适配Elasticsearch？主要原因如下：**

- Elasticsearch是开源的。 
- Elasticsearch提供了JAVA API接口。
- Elasticsearch提供了RESTful API接口（不管程序用什么语言开发，任何程序都可以访问） 
- 更重要的是，REST请求和应答是典型的JSON（JavaScript对象 符号）格式。通常情况下，一个REST请求包含一个JSON文件，其回复都 也是一个JSON文件。
[toc]



# JVM æ€§èƒ½è°ƒä¼˜

## 1. JVM è°ƒä¼˜æ¦‚è¿°

### 1.1. GC æ€§èƒ½æŒ‡æ ‡

å¯¹äº JVM è°ƒä¼˜æ¥è¯´ï¼Œéœ€è¦å…ˆæ˜ç¡®è°ƒä¼˜çš„ç›®æ ‡ã€‚ ä»æ€§èƒ½çš„è§’åº¦çœ‹ï¼Œé€šå¸¸å…³æ³¨ä¸‰ä¸ªæŒ‡æ ‡ï¼š

- `ååé‡ï¼ˆthroughputï¼‰` - æŒ‡ä¸è€ƒè™‘ GC å¼•èµ·çš„åœé¡¿æ—¶é—´æˆ–å†…å­˜æ¶ˆè€—ï¼Œåƒåœ¾æ”¶é›†å™¨èƒ½æ”¯æ’‘åº”ç”¨è¾¾åˆ°çš„æœ€é«˜æ€§èƒ½æŒ‡æ ‡ã€‚
- `åœé¡¿æ—¶é—´ï¼ˆlatencyï¼‰` - å…¶åº¦é‡æ ‡å‡†æ˜¯ç¼©çŸ­ç”±äºåƒåœ¾å•Šæ”¶é›†å¼•èµ·çš„åœé¡¿æ—¶é—´æˆ–è€…å®Œå…¨æ¶ˆé™¤å› åƒåœ¾æ”¶é›†æ‰€å¼•èµ·çš„åœé¡¿ï¼Œé¿å…åº”ç”¨è¿è¡Œæ—¶å‘ç”ŸæŠ–åŠ¨ã€‚
- `åƒåœ¾å›æ”¶é¢‘ç‡` - ä¹…å‘ç”Ÿä¸€æ¬¡æŒ‡åƒåœ¾å›æ”¶å‘¢ï¼Ÿé€šå¸¸åƒåœ¾å›æ”¶çš„é¢‘ç‡è¶Šä½è¶Šå¥½ï¼Œå¢å¤§å †å†…å­˜ç©ºé—´å¯ä»¥æœ‰æ•ˆé™ä½åƒåœ¾å›æ”¶å‘ç”Ÿçš„é¢‘ç‡ï¼Œä½†åŒæ—¶ä¹Ÿæ„å‘³ç€å †ç§¯çš„å›æ”¶å¯¹è±¡è¶Šå¤šï¼Œæœ€ç»ˆä¹Ÿä¼šå¢åŠ å›æ”¶æ—¶çš„åœé¡¿æ—¶é—´ã€‚æ‰€ä»¥æˆ‘ä»¬åªè¦é€‚å½“åœ°å¢å¤§å †å†…å­˜ç©ºé—´ï¼Œä¿è¯æ­£å¸¸çš„åƒåœ¾å›æ”¶é¢‘ç‡å³å¯ã€‚

å¤§å¤šæ•°æƒ…å†µä¸‹è°ƒä¼˜ä¼šä¾§é‡äºå…¶ä¸­ä¸€ä¸ªæˆ–è€…ä¸¤ä¸ªæ–¹é¢çš„ç›®æ ‡ï¼Œå¾ˆå°‘æœ‰æƒ…å†µå¯ä»¥å…¼é¡¾ä¸‰ä¸ªä¸åŒçš„è§’åº¦ã€‚

### 1.2. è°ƒä¼˜åŸåˆ™

GC ä¼˜åŒ–çš„ä¸¤ä¸ªç›®æ ‡ï¼š

- **é™ä½ Full GC çš„é¢‘ç‡**
- **å‡å°‘ Full GC çš„æ‰§è¡Œæ—¶é—´**

GC ä¼˜åŒ–çš„åŸºæœ¬åŸåˆ™æ˜¯ï¼šå°†ä¸åŒçš„ GC å‚æ•°åº”ç”¨åˆ°ä¸¤ä¸ªåŠä»¥ä¸Šçš„æœåŠ¡å™¨ä¸Šç„¶åæ¯”è¾ƒå®ƒä»¬çš„æ€§èƒ½ï¼Œç„¶åå°†é‚£äº›è¢«è¯æ˜å¯ä»¥æé«˜æ€§èƒ½æˆ–å‡å°‘ GC æ‰§è¡Œæ—¶é—´çš„å‚æ•°åº”ç”¨äºæœ€ç»ˆçš„å·¥ä½œæœåŠ¡å™¨ä¸Šã€‚

#### 1.2.1.é™ä½ Minor GC é¢‘ç‡

å¦‚æœæ–°ç”Ÿä»£ç©ºé—´è¾ƒå°ï¼ŒEden åŒºå¾ˆå¿«è¢«å¡«æ»¡ï¼Œå°±ä¼šå¯¼è‡´é¢‘ç¹ Minor GCï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡å¢å¤§æ–°ç”Ÿä»£ç©ºé—´æ¥é™ä½ Minor GC çš„é¢‘ç‡ã€‚

å¯èƒ½ä½ ä¼šæœ‰è¿™æ ·çš„ç–‘é—®ï¼Œæ‰©å®¹ Eden åŒºè™½ç„¶å¯ä»¥å‡å°‘ Minor GC çš„æ¬¡æ•°ï¼Œä½†ä¸ä¼šå¢åŠ å•æ¬¡ Minor GC çš„æ—¶é—´å—ï¼Ÿå¦‚æœå•æ¬¡ Minor GC çš„æ—¶é—´å¢åŠ ï¼Œé‚£ä¹Ÿå¾ˆéš¾è¾¾åˆ°æˆ‘ä»¬æœŸå¾…çš„ä¼˜åŒ–æ•ˆæœå‘€ã€‚

æˆ‘ä»¬çŸ¥é“ï¼Œå•æ¬¡ Minor GC æ—¶é—´æ˜¯ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šT1ï¼ˆæ‰«ææ–°ç”Ÿä»£ï¼‰å’Œ T2ï¼ˆå¤åˆ¶å­˜æ´»å¯¹è±¡ï¼‰ã€‚å‡è®¾ä¸€ä¸ªå¯¹è±¡åœ¨ Eden åŒºçš„å­˜æ´»æ—¶é—´ä¸º 500msï¼ŒMinor GC çš„æ—¶é—´é—´éš”æ˜¯ 300msï¼Œé‚£ä¹ˆæ­£å¸¸æƒ…å†µä¸‹ï¼ŒMinor GC çš„æ—¶é—´ä¸º ï¼šT1+T2ã€‚

å½“æˆ‘ä»¬å¢å¤§æ–°ç”Ÿä»£ç©ºé—´ï¼ŒMinor GC çš„æ—¶é—´é—´éš”å¯èƒ½ä¼šæ‰©å¤§åˆ° 600msï¼Œæ­¤æ—¶ä¸€ä¸ªå­˜æ´» 500ms çš„å¯¹è±¡å°±ä¼šåœ¨ Eden åŒºä¸­è¢«å›æ”¶æ‰ï¼Œæ­¤æ—¶å°±ä¸å­˜åœ¨å¤åˆ¶å­˜æ´»å¯¹è±¡äº†ï¼Œæ‰€ä»¥å†å‘ç”Ÿ Minor GC çš„æ—¶é—´ä¸ºï¼šä¸¤æ¬¡æ‰«ææ–°ç”Ÿä»£ï¼Œå³ 2T1ã€‚

å¯è§ï¼Œæ‰©å®¹åï¼ŒMinor GC æ—¶å¢åŠ äº† T1ï¼Œä½†çœå»äº† T2 çš„æ—¶é—´ã€‚é€šå¸¸åœ¨è™šæ‹Ÿæœºä¸­ï¼Œå¤åˆ¶å¯¹è±¡çš„æˆæœ¬è¦è¿œé«˜äºæ‰«ææˆæœ¬ã€‚

å¦‚æœåœ¨å †å†…å­˜ä¸­å­˜åœ¨è¾ƒå¤šçš„é•¿æœŸå­˜æ´»çš„å¯¹è±¡ï¼Œæ­¤æ—¶å¢åŠ å¹´è½»ä»£ç©ºé—´ï¼Œåè€Œä¼šå¢åŠ  Minor GC çš„æ—¶é—´ã€‚å¦‚æœå †ä¸­çš„çŸ­æœŸå¯¹è±¡å¾ˆå¤šï¼Œé‚£ä¹ˆæ‰©å®¹æ–°ç”Ÿä»£ï¼Œå•æ¬¡ Minor GC æ—¶é—´ä¸ä¼šæ˜¾è‘—å¢åŠ ã€‚å› æ­¤ï¼Œå•æ¬¡ Minor GC æ—¶é—´æ›´å¤šå–å†³äº GC åå­˜æ´»å¯¹è±¡çš„æ•°é‡ï¼Œè€Œé Eden åŒºçš„å¤§å°ã€‚

#### 1.2.2.é™ä½ Full GC çš„é¢‘ç‡

Full GC ç›¸å¯¹æ¥è¯´ä¼šæ¯” Minor GC æ›´è€—æ—¶ã€‚å‡å°‘è¿›å…¥è€å¹´ä»£çš„å¯¹è±¡æ•°é‡å¯ä»¥æ˜¾è‘—é™ä½ Full GC çš„é¢‘ç‡ã€‚

**å‡å°‘åˆ›å»ºå¤§å¯¹è±¡ï¼š\**å¦‚æœ\**å¯¹è±¡å ç”¨å†…å­˜è¿‡å¤§ï¼Œåœ¨ Eden åŒºè¢«åˆ›å»ºåä¼šç›´æ¥è¢«ä¼ å…¥è€å¹´ä»£**ã€‚åœ¨å¹³å¸¸çš„ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬ä¹ æƒ¯ä¸€æ¬¡æ€§ä»æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºä¸€ä¸ªå¤§å¯¹è±¡ç”¨äº web ç«¯æ˜¾ç¤ºã€‚ä¾‹å¦‚ï¼Œæˆ‘ä¹‹å‰ç¢°åˆ°è¿‡ä¸€ä¸ªä¸€æ¬¡æ€§æŸ¥è¯¢å‡º 60 ä¸ªå­—æ®µçš„ä¸šåŠ¡æ“ä½œï¼Œè¿™ç§å¤§å¯¹è±¡å¦‚æœè¶…è¿‡å¹´è½»ä»£æœ€å¤§å¯¹è±¡é˜ˆå€¼ï¼Œä¼šè¢«ç›´æ¥åˆ›å»ºåœ¨è€å¹´ä»£ï¼›å³ä½¿è¢«åˆ›å»ºåœ¨äº†å¹´è½»ä»£ï¼Œç”±äºå¹´è½»ä»£çš„å†…å­˜ç©ºé—´æœ‰é™ï¼Œé€šè¿‡ Minor GC ä¹‹åä¹Ÿä¼šè¿›å…¥åˆ°è€å¹´ä»£ã€‚è¿™ç§å¤§å¯¹è±¡å¾ˆå®¹æ˜“äº§ç”Ÿè¾ƒå¤šçš„ Full GCã€‚

æˆ‘ä»¬å¯ä»¥å°†è¿™ç§å¤§å¯¹è±¡æ‹†è§£å‡ºæ¥ï¼Œé¦–æ¬¡åªæŸ¥è¯¢ä¸€äº›æ¯”è¾ƒé‡è¦çš„å­—æ®µï¼Œå¦‚æœè¿˜éœ€è¦å…¶å®ƒå­—æ®µè¾…åŠ©æŸ¥çœ‹ï¼Œå†é€šè¿‡ç¬¬äºŒæ¬¡æŸ¥è¯¢æ˜¾ç¤ºå‰©ä½™çš„å­—æ®µã€‚

**å¢å¤§å †å†…å­˜ç©ºé—´ï¼š**åœ¨å †å†…å­˜ä¸è¶³çš„æƒ…å†µä¸‹ï¼Œå¢å¤§å †å†…å­˜ç©ºé—´ï¼Œä¸”è®¾ç½®åˆå§‹åŒ–å †å†…å­˜ä¸ºæœ€å¤§å †å†…å­˜ï¼Œä¹Ÿå¯ä»¥é™ä½ Full GC çš„é¢‘ç‡ã€‚

#### 1.2.3.é™ä½ Full GC çš„æ—¶é—´

Full GC çš„æ‰§è¡Œæ—¶é—´æ¯” Minor GC è¦é•¿å¾ˆå¤šï¼Œå› æ­¤ï¼Œå¦‚æœåœ¨ Full GC ä¸ŠèŠ±è´¹è¿‡å¤šçš„æ—¶é—´ï¼ˆè¶…è¿‡ 1sï¼‰ï¼Œå°†å¯èƒ½å‡ºç°è¶…æ—¶é”™è¯¯ã€‚

- å¦‚æœ**é€šè¿‡å‡å°è€å¹´ä»£å†…å­˜æ¥å‡å°‘ Full GC æ—¶é—´**ï¼Œå¯èƒ½ä¼šå¼•èµ· `OutOfMemoryError` æˆ–è€…å¯¼è‡´ Full GC çš„é¢‘ç‡å‡é«˜ã€‚
- å¦å¤–ï¼Œå¦‚æœ**é€šè¿‡å¢åŠ è€å¹´ä»£å†…å­˜æ¥é™ä½ Full GC çš„é¢‘ç‡**ï¼ŒFull GC çš„æ—¶é—´å¯èƒ½å› æ­¤å¢åŠ ã€‚

å› æ­¤ï¼Œä½ **éœ€è¦æŠŠè€å¹´ä»£çš„å¤§å°è®¾ç½®æˆä¸€ä¸ªâ€œåˆé€‚â€çš„å€¼**ã€‚



### 1.3. GC ä¼˜åŒ–çš„è¿‡ç¨‹

GC ä¼˜åŒ–çš„è¿‡ç¨‹å¤§è‡´å¯åˆ†ä¸ºä»¥ä¸‹æ­¥éª¤ï¼š

#### ï¼ˆ1ï¼‰ç›‘æ§ GC çŠ¶æ€

ä½ éœ€è¦ç›‘æ§ GC ä»è€Œæ£€æŸ¥ç³»ç»Ÿä¸­è¿è¡Œçš„ GC çš„å„ç§çŠ¶æ€ã€‚

#### ï¼ˆ2ï¼‰åˆ†æ GC æ—¥å¿—

åœ¨æ£€æŸ¥ GC çŠ¶æ€åï¼Œä½ éœ€è¦åˆ†æç›‘æ§ç»“æ„å¹¶å†³å®šæ˜¯å¦éœ€è¦è¿›è¡Œ GC ä¼˜åŒ–ã€‚å¦‚æœåˆ†æç»“æœæ˜¾ç¤ºè¿è¡Œ GC çš„æ—¶é—´åªæœ‰ 0.1-0.3 ç§’ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦æŠŠæ—¶é—´æµªè´¹åœ¨ GC ä¼˜åŒ–ä¸Šï¼Œä½†å¦‚æœè¿è¡Œ GC çš„æ—¶é—´è¾¾åˆ° 1-3 ç§’ï¼Œç”šè‡³å¤§äº 10 ç§’ï¼Œé‚£ä¹ˆ GC ä¼˜åŒ–å°†æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚

ä½†æ˜¯ï¼Œå¦‚æœä½ å·²ç»åˆ†é…äº†å¤§çº¦ 10GB å†…å­˜ç»™ Javaï¼Œå¹¶ä¸”è¿™äº›å†…å­˜æ— æ³•çœä¸‹ï¼Œé‚£ä¹ˆå°±æ— æ³•è¿›è¡Œ GC ä¼˜åŒ–äº†ã€‚åœ¨è¿›è¡Œ GC ä¼˜åŒ–ä¹‹å‰ï¼Œä½ éœ€è¦è€ƒè™‘ä¸ºä»€ä¹ˆä½ éœ€è¦åˆ†é…è¿™ä¹ˆå¤§çš„å†…å­˜ç©ºé—´ï¼Œå¦‚æœä½ åˆ†é…äº† 1GB æˆ– 2GB å¤§å°çš„å†…å­˜å¹¶ä¸”å‡ºç°äº†`OutOfMemoryError`ï¼Œé‚£ä½ å°±åº”è¯¥æ‰§è¡Œ**å †å¿«ç…§ï¼ˆheap dumpï¼‰**æ¥æ¶ˆé™¤å¯¼è‡´å¼‚å¸¸çš„åŸå› ã€‚

> ğŸ”” æ³¨æ„ï¼š

> **å †å¿«ç…§ï¼ˆheap dumpï¼‰**æ˜¯ä¸€ä¸ªç”¨æ¥æ£€æŸ¥ Java å†…å­˜ä¸­çš„å¯¹è±¡å’Œæ•°æ®çš„å†…å­˜æ–‡ä»¶ã€‚è¯¥æ–‡ä»¶å¯ä»¥é€šè¿‡æ‰§è¡Œ JDK ä¸­çš„`jmap`å‘½ä»¤æ¥åˆ›å»ºã€‚åœ¨åˆ›å»ºæ–‡ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œæ‰€æœ‰ Java ç¨‹åºéƒ½å°†æš‚åœï¼Œå› æ­¤ï¼Œä¸è¦åœ¨ç³»ç»Ÿæ‰§è¡Œè¿‡ç¨‹ä¸­åˆ›å»ºè¯¥æ–‡ä»¶ã€‚

> ä½ å¯ä»¥åœ¨äº’è”ç½‘ä¸Šæœç´¢ heap dump çš„è¯¦ç»†è¯´æ˜ã€‚

#### ï¼ˆ3ï¼‰é€‰æ‹©åˆé€‚ GC å›æ”¶å™¨

å¦‚æœä½ å†³å®šè¦è¿›è¡Œ GC ä¼˜åŒ–ï¼Œé‚£ä¹ˆä½ éœ€è¦é€‰æ‹©ä¸€ä¸ª GC å›æ”¶å™¨ï¼Œå¹¶ä¸”ä¸ºå®ƒè®¾ç½®åˆç† JVM å‚æ•°ã€‚æ­¤æ—¶å¦‚æœä½ æœ‰å¤šä¸ªæœåŠ¡å™¨ï¼Œè¯·å¦‚ä¸Šæ–‡æåˆ°çš„é‚£æ ·ï¼Œåœ¨æ¯å°æœºå™¨ä¸Šè®¾ç½®ä¸åŒçš„ GC å‚æ•°å¹¶åˆ†æå®ƒä»¬çš„åŒºåˆ«ã€‚

#### ï¼ˆ4ï¼‰åˆ†æç»“æœ

åœ¨è®¾ç½®å®Œ GC å‚æ•°åå°±å¯ä»¥å¼€å§‹æ”¶é›†æ•°æ®ï¼Œè¯·åœ¨æ”¶é›†è‡³å°‘ 24 å°æ—¶åå†è¿›è¡Œç»“æœåˆ†æã€‚å¦‚æœä½ è¶³å¤Ÿå¹¸è¿ï¼Œä½ å¯èƒ½ä¼šæ‰¾åˆ°ç³»ç»Ÿçš„æœ€ä½³ GC å‚æ•°ã€‚å¦‚è‹¥ä¸ç„¶ï¼Œä½ è¿˜éœ€è¦åˆ†æè¾“å‡ºæ—¥å¿—å¹¶æ£€æŸ¥åˆ†é…çš„å†…å­˜ï¼Œç„¶åéœ€è¦é€šè¿‡ä¸æ–­è°ƒæ•´ GC ç±»å‹/å†…å­˜å¤§å°æ¥æ‰¾åˆ°ç³»ç»Ÿçš„æœ€ä½³å‚æ•°ã€‚

#### ï¼ˆ5ï¼‰åº”ç”¨ä¼˜åŒ–é…ç½®

å¦‚æœ GC ä¼˜åŒ–çš„ç»“æœä»¤äººæ»¡æ„ï¼Œå°±å¯ä»¥å°†å‚æ•°åº”ç”¨åˆ°æ‰€æœ‰æœåŠ¡å™¨ä¸Šï¼Œå¹¶åœæ­¢ GC ä¼˜åŒ–ã€‚

åœ¨ä¸‹é¢çš„ç« èŠ‚ä¸­ï¼Œä½ å°†ä¼šçœ‹åˆ°ä¸Šè¿°æ¯ä¸€æ­¥æ‰€åšçš„å…·ä½“å·¥ä½œã€‚

## 2. GC æ—¥å¿—

### 2.1. è·å– GC æ—¥å¿—

è·å– GC æ—¥å¿—æœ‰ä¸¤ç§æ–¹å¼ï¼š

- ä½¿ç”¨ `jstat` å‘½ä»¤åŠ¨æ€æŸ¥çœ‹
- åœ¨å®¹å™¨ä¸­è®¾ç½®ç›¸å…³å‚æ•°æ‰“å° GC æ—¥å¿—

#### jstat å‘½ä»¤æŸ¥çœ‹ GC

`jstat -gc` ç»Ÿè®¡åƒåœ¾å›æ”¶å †çš„è¡Œä¸ºï¼š

```
jstat -gc 1262
 S0C    S1C     S0U     S1U   EC       EU        OC         OU        PC       PU         YGC    YGCT    FGC    FGCT     GCT
26112.0 24064.0 6562.5  0.0   564224.0 76274.5   434176.0   388518.3  524288.0 42724.7    320    6.417   1      0.398    6.815
```

ä¹Ÿå¯ä»¥è®¾ç½®é—´éš”å›ºå®šæ—¶é—´æ¥æ‰“å°ï¼š

```
jstat -gc 1262 2000 20
```

è¿™ä¸ªå‘½ä»¤æ„æ€å°±æ˜¯æ¯éš” 2000ms è¾“å‡º 1262 çš„ gc æƒ…å†µï¼Œä¸€å…±è¾“å‡º 20 æ¬¡

#### æ‰“å° GC çš„å‚æ•°

é€šè¿‡ JVM å‚æ•°é¢„å…ˆè®¾ç½® GC æ—¥å¿—ï¼Œé€šå¸¸æœ‰ä»¥ä¸‹å‡ ç§ JVM å‚æ•°è®¾ç½®ï¼š

```
-XX:+PrintGC è¾“å‡º GC æ—¥å¿—
-XX:+PrintGCDetails è¾“å‡º GC çš„è¯¦ç»†æ—¥å¿—
-XX:+PrintGCTimeStamps è¾“å‡º GC çš„æ—¶é—´æˆ³ï¼ˆä»¥åŸºå‡†æ—¶é—´çš„å½¢å¼ï¼‰
-XX:+PrintGCDateStamps è¾“å‡º GC çš„æ—¶é—´æˆ³ï¼ˆä»¥æ—¥æœŸçš„å½¢å¼ï¼Œå¦‚ 2013-05-04T21:53:59.234+0800ï¼‰
-XX:+PrintHeapAtGC åœ¨è¿›è¡Œ GC çš„å‰åæ‰“å°å‡ºå †çš„ä¿¡æ¯
-verbose:gc -Xloggc:../logs/gc.log æ—¥å¿—æ–‡ä»¶çš„è¾“å‡ºè·¯å¾„
```

å¦‚æœæ˜¯é•¿æ—¶é—´çš„ GC æ—¥å¿—ï¼Œæˆ‘ä»¬å¾ˆéš¾é€šè¿‡æ–‡æœ¬å½¢å¼å»æŸ¥çœ‹æ•´ä½“çš„ GC æ€§èƒ½ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡[GCView](https://sourceforge.net/projects/gcviewer/)å·¥å…·æ‰“å¼€æ—¥å¿—æ–‡ä»¶ï¼Œå›¾å½¢åŒ–ç•Œé¢æŸ¥çœ‹æ•´ä½“çš„ GC æ€§èƒ½ã€‚

ã€ç¤ºä¾‹ã€‘Tomcat è®¾ç½®ç¤ºä¾‹

```
JAVA_OPTS="-server -Xms2000m -Xmx2000m -Xmn800m -XX:PermSize=64m -XX:MaxPermSize=256m -XX:SurvivorRatio=4
-verbose:gc -Xloggc:$CATALINA_HOME/logs/gc.log
-Djava.awt.headless=true
-XX:+PrintGCTimeStamps -XX:+PrintGCDetails
-Dsun.rmi.dgc.server.gcInterval=600000 -Dsun.rmi.dgc.client.gcInterval=600000
-XX:+UseConcMarkSweepGC -XX:MaxTenuringThreshold=15"
```

- `-Xms2000m -Xmx2000m -Xmn800m -XX:PermSize=64m -XX:MaxPermSize=256m` Xmsï¼Œå³ä¸º jvm å¯åŠ¨æ—¶å¾— JVM åˆå§‹å †å¤§å°,Xmx ä¸º jvm çš„æœ€å¤§å †å¤§å°ï¼Œxmn ä¸ºæ–°ç”Ÿä»£çš„å¤§å°ï¼Œpermsize ä¸ºæ°¸ä¹…ä»£çš„åˆå§‹å¤§å°ï¼ŒMaxPermSize ä¸ºæ°¸ä¹…ä»£çš„æœ€å¤§ç©ºé—´ã€‚
- `-XX:SurvivorRatio=4` SurvivorRatio ä¸ºæ–°ç”Ÿä»£ç©ºé—´ä¸­çš„ Eden åŒºå’Œæ•‘åŠ©ç©ºé—´ Survivor åŒºçš„å¤§å°æ¯”å€¼ï¼Œé»˜è®¤æ˜¯ 8ï¼Œåˆ™ä¸¤ä¸ª Survivor åŒºä¸ä¸€ä¸ª Eden åŒºçš„æ¯”å€¼ä¸º 2:8,ä¸€ä¸ª Survivor åŒºå æ•´ä¸ªå¹´è½»ä»£çš„ 1/10ã€‚è°ƒå°è¿™ä¸ªå‚æ•°å°†å¢å¤§ survivor åŒºï¼Œè®©å¯¹è±¡å°½é‡åœ¨ survitor åŒºå‘†é•¿ä¸€ç‚¹ï¼Œå‡å°‘è¿›å…¥å¹´è€ä»£çš„å¯¹è±¡ã€‚å»æ‰æ•‘åŠ©ç©ºé—´çš„æƒ³æ³•æ˜¯è®©å¤§éƒ¨åˆ†ä¸èƒ½é©¬ä¸Šå›æ”¶çš„æ•°æ®å°½å¿«è¿›å…¥å¹´è€ä»£ï¼ŒåŠ å¿«å¹´è€ä»£çš„å›æ”¶é¢‘ç‡ï¼Œå‡å°‘å¹´è€ä»£æš´æ¶¨çš„å¯èƒ½æ€§ï¼Œè¿™ä¸ªæ˜¯é€šè¿‡å°†-XX:SurvivorRatio è®¾ç½®æˆæ¯”è¾ƒå¤§çš„å€¼ï¼ˆæ¯”å¦‚ 65536)æ¥åšåˆ°ã€‚
- `-verbose:gc -Xloggc:$CATALINA_HOME/logs/gc.log` å°†è™šæ‹Ÿæœºæ¯æ¬¡åƒåœ¾å›æ”¶çš„ä¿¡æ¯å†™åˆ°æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œæ–‡ä»¶åç”± file æŒ‡å®šï¼Œæ–‡ä»¶æ ¼å¼æ˜¯å¹³æ–‡ä»¶ï¼Œå†…å®¹å’Œ-verbose:gc è¾“å‡ºå†…å®¹ç›¸åŒã€‚
- `-Djava.awt.headless=true` Headless æ¨¡å¼æ˜¯ç³»ç»Ÿçš„ä¸€ç§é…ç½®æ¨¡å¼ã€‚åœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œç³»ç»Ÿç¼ºå°‘äº†æ˜¾ç¤ºè®¾å¤‡ã€é”®ç›˜æˆ–é¼ æ ‡ã€‚
- `-XX:+PrintGCTimeStamps -XX:+PrintGCDetails` è®¾ç½® gc æ—¥å¿—çš„æ ¼å¼
- `-Dsun.rmi.dgc.server.gcInterval=600000 -Dsun.rmi.dgc.client.gcInterval=600000` æŒ‡å®š rmi è°ƒç”¨æ—¶ gc çš„æ—¶é—´é—´éš”
- `-XX:+UseConcMarkSweepGC -XX:MaxTenuringThreshold=15` é‡‡ç”¨å¹¶å‘ gc æ–¹å¼ï¼Œç»è¿‡ 15 æ¬¡ minor gc åè¿›å…¥å¹´è€ä»£

### 2.2. åˆ†æ GC æ—¥å¿—

Young GC å›æ”¶æ—¥å¿—:

```
2016-07-05T10:43:18.093+0800: 25.395: [GC [PSYoungGen: 274931K->10738K(274944K)] 371093K->147186K(450048K), 0.0668480 secs] [Times: user=0.17 sys=0.08, real=0.07 secs]
```

Full GC å›æ”¶æ—¥å¿—:

```
2016-07-05T10:43:18.160+0800: 25.462: [Full GC [PSYoungGen: 10738K->0K(274944K)] [ParOldGen: 136447K->140379K(302592K)] 147186K->140379K(577536K) [PSPermGen: 85411K->85376K(171008K)], 0.6763541 secs] [Times: user=1.75 sys=0.02, real=0.68 secs]
```

é€šè¿‡ä¸Šé¢æ—¥å¿—åˆ†æå¾—å‡ºï¼ŒPSYoungGenã€ParOldGenã€PSPermGen å±äº Parallel æ”¶é›†å™¨ã€‚å…¶ä¸­ PSYoungGen è¡¨ç¤º gc å›æ”¶å‰åå¹´è½»ä»£çš„å†…å­˜å˜åŒ–ï¼›ParOldGen è¡¨ç¤º gc å›æ”¶å‰åè€å¹´ä»£çš„å†…å­˜å˜åŒ–ï¼›PSPermGen è¡¨ç¤º gc å›æ”¶å‰åæ°¸ä¹…åŒºçš„å†…å­˜å˜åŒ–ã€‚young gc ä¸»è¦æ˜¯é’ˆå¯¹å¹´è½»ä»£è¿›è¡Œå†…å­˜å›æ”¶æ¯”è¾ƒé¢‘ç¹ï¼Œè€—æ—¶çŸ­ï¼›full gc ä¼šå¯¹æ•´ä¸ªå †å†…å­˜è¿›è¡Œå›åŸï¼Œè€—æ—¶é•¿ï¼Œå› æ­¤ä¸€èˆ¬å°½é‡å‡å°‘ full gc çš„æ¬¡æ•°



#### CPU è¿‡é«˜

å®šä½æ­¥éª¤ï¼š

ï¼ˆ1ï¼‰æ‰§è¡Œ top -c å‘½ä»¤ï¼Œæ‰¾åˆ° cpu æœ€é«˜çš„è¿›ç¨‹çš„ id

ï¼ˆ2ï¼‰jstack PID å¯¼å‡º Java åº”ç”¨ç¨‹åºçš„çº¿ç¨‹å †æ ˆä¿¡æ¯ã€‚

ç¤ºä¾‹ï¼š

```
jstack 6795

"Low Memory Detector" daemon prio=10 tid=0x081465f8 nid=0x7 runnable [0x00000000..0x00000000]
        "CompilerThread0" daemon prio=10 tid=0x08143c58 nid=0x6 waiting on condition [0x00000000..0xfb5fd798]
        "Signal Dispatcher" daemon prio=10 tid=0x08142f08 nid=0x5 waiting on condition [0x00000000..0x00000000]
        "Finalizer" daemon prio=10 tid=0x08137ca0 nid=0x4 in Object.wait() [0xfbeed000..0xfbeeddb8]

        at java.lang.Object.wait(Native Method)

        - waiting on <0xef600848> (a java.lang.ref.ReferenceQueue$Lock)

        at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:116)

        - locked <0xef600848> (a java.lang.ref.ReferenceQueue$Lock)

        at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:132)

        at java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:159)

        "Reference Handler" daemon prio=10 tid=0x081370f0 nid=0x3 in Object.wait() [0xfbf4a000..0xfbf4aa38]

        at java.lang.Object.wait(Native Method)

        - waiting on <0xef600758> (a java.lang.ref.Reference$Lock)

        at java.lang.Object.wait(Object.java:474)

        at java.lang.ref.Reference$ReferenceHandler.run(Reference.java:116)

        - locked <0xef600758> (a java.lang.ref.Reference$Lock)

        "VM Thread" prio=10 tid=0x08134878 nid=0x2 runnable

        "VM Periodic Task Thread" prio=10 tid=0x08147768 nid=0x8 waiting on condition
```

åœ¨æ‰“å°çš„å †æ ˆæ—¥å¿—æ–‡ä»¶ä¸­ï¼Œtid å’Œ nid çš„å«ä¹‰ï¼š

```
nid : å¯¹åº”çš„ Linux æ“ä½œç³»ç»Ÿä¸‹çš„ tid çº¿ç¨‹å·ï¼Œä¹Ÿå°±æ˜¯å‰é¢è½¬åŒ–çš„ 16 è¿›åˆ¶æ•°å­—
tid: è¿™ä¸ªåº”è¯¥æ˜¯ jvm çš„ jmm å†…å­˜è§„èŒƒä¸­çš„å”¯ä¸€åœ°å€å®šä½
```

åœ¨ CPU è¿‡é«˜çš„æƒ…å†µä¸‹ï¼ŒæŸ¥æ‰¾å“åº”çš„çº¿ç¨‹ï¼Œä¸€èˆ¬å®šä½éƒ½æ˜¯ç”¨ nid æ¥å®šä½çš„ã€‚è€Œå¦‚æœå‘ç”Ÿæ­»é”ä¹‹ç±»çš„é—®é¢˜ï¼Œä¸€èˆ¬ç”¨ tid æ¥å®šä½ã€‚

ï¼ˆ3ï¼‰å®šä½ CPU é«˜çš„çº¿ç¨‹æ‰“å°å…¶ nid

æŸ¥çœ‹çº¿ç¨‹ä¸‹å…·ä½“è¿›ç¨‹ä¿¡æ¯çš„å‘½ä»¤å¦‚ä¸‹ï¼š

top -H -p 6735

```
top - 14:20:09 up 611 days,  2:56,  1 user,  load average: 13.19, 7.76, 7.82
Threads: 6991 total,  17 running, 6974 sleeping,   0 stopped,   0 zombie
%Cpu(s): 90.4 us,  2.1 sy,  0.0 ni,  7.0 id,  0.0 wa,  0.0 hi,  0.4 si,  0.0 st
KiB Mem:  32783044 total, 32505008 used,   278036 free,   120304 buffers
KiB Swap:        0 total,        0 used,        0 free. 4497428 cached Mem

  PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND
 6800 root      20   0 27.299g 0.021t   7172 S 54.7 70.1 187:55.61 java
 6803 root      20   0 27.299g 0.021t   7172 S 54.4 70.1 187:52.59 java
 6798 root      20   0 27.299g 0.021t   7172 S 53.7 70.1 187:55.08 java
 6801 root      20   0 27.299g 0.021t   7172 S 53.7 70.1 187:55.25 java
 6797 root      20   0 27.299g 0.021t   7172 S 53.1 70.1 187:52.78 java
 6804 root      20   0 27.299g 0.021t   7172 S 53.1 70.1 187:55.76 java
 6802 root      20   0 27.299g 0.021t   7172 S 52.1 70.1 187:54.79 java
 6799 root      20   0 27.299g 0.021t   7172 S 51.8 70.1 187:53.36 java
 6807 root      20   0 27.299g 0.021t   7172 S 13.6 70.1  48:58.60 java
11014 root      20   0 27.299g 0.021t   7172 R  8.4 70.1   8:00.32 java
10642 root      20   0 27.299g 0.021t   7172 R  6.5 70.1   6:32.06 java
 6808 root      20   0 27.299g 0.021t   7172 S  6.1 70.1 159:08.40 java
11315 root      20   0 27.299g 0.021t   7172 S  3.9 70.1   5:54.10 java
12545 root      20   0 27.299g 0.021t   7172 S  3.9 70.1   6:55.48 java
23353 root      20   0 27.299g 0.021t   7172 S  3.9 70.1   2:20.55 java
24868 root      20   0 27.299g 0.021t   7172 S  3.9 70.1   2:12.46 java
 9146 root      20   0 27.299g 0.021t   7172 S  3.6 70.1   7:42.72 java
```

ç”±æ­¤å¯ä»¥çœ‹å‡ºå ç”¨ CPU è¾ƒé«˜çš„çº¿ç¨‹ï¼Œä½†æ˜¯è¿™äº›è¿˜ä¸é«˜ï¼Œæ— æ³•ç›´æ¥å®šä½åˆ°å…·ä½“çš„ç±»ã€‚nid æ˜¯ 16 è¿›åˆ¶çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦è·å–çº¿ç¨‹çš„ 16 è¿›åˆ¶ IDï¼š

```
printf "%x\n" 6800
è¾“å‡ºç»“æœ:45cd
```

ç„¶åæ ¹æ®è¾“å‡ºç»“æœåˆ° jstack æ‰“å°çš„å †æ ˆæ—¥å¿—ä¸­æŸ¥å®šä½ï¼š

```
"catalina-exec-5692" daemon prio=10 tid=0x00007f3b05013800 nid=0x45cd waiting on condition [0x00007f3ae08e3000]
   java.lang.Thread.State: TIMED_WAITING (parking)
        at sun.misc.Unsafe.park(Native Method)
        - parking to wait for  <0x00000006a7800598> (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
        at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:226)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:2082)
        at java.util.concurrent.LinkedBlockingQueue.poll(LinkedBlockingQueue.java:467)
        at org.apache.tomcat.util.threads.TaskQueue.poll(TaskQueue.java:86)
        at org.apache.tomcat.util.threads.TaskQueue.poll(TaskQueue.java:32)
        at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1068)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
        at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)
        at java.lang.Thread.run(Thread.java:745)
```

## 3. GC é…ç½®

> è¯¦ç»†å‚æ•°è¯´æ˜è¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š[JavaHotSpot VM Options](http://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html)ï¼Œè¿™é‡Œä»…åˆ—ä¸¾å¸¸ç”¨å‚æ•°ã€‚

### 3.1. å †å¤§å°è®¾ç½®

**å¹´è½»ä»£çš„è®¾ç½®å¾ˆå…³é”®ã€‚**

JVM ä¸­æœ€å¤§å †å¤§å°æœ‰ä¸‰æ–¹é¢é™åˆ¶ï¼š

1. ç›¸å…³æ“ä½œç³»ç»Ÿçš„æ•°æ®æ¨¡å‹ï¼ˆ32-bt è¿˜æ˜¯ 64-bitï¼‰é™åˆ¶ï¼›
2. ç³»ç»Ÿçš„å¯ç”¨è™šæ‹Ÿå†…å­˜é™åˆ¶ï¼›
3. ç³»ç»Ÿçš„å¯ç”¨ç‰©ç†å†…å­˜é™åˆ¶ã€‚

```
æ•´ä¸ªå †å¤§å° = å¹´è½»ä»£å¤§å° + å¹´è€ä»£å¤§å° + æŒä¹…ä»£å¤§å°
```

- æŒä¹…ä»£ä¸€èˆ¬å›ºå®šå¤§å°ä¸º `64m`ã€‚ä½¿ç”¨ `-XX:PermSize` è®¾ç½®ã€‚
- å®˜æ–¹æ¨èå¹´è½»ä»£å æ•´ä¸ªå †çš„ 3/8ã€‚ä½¿ç”¨ `-Xmn` è®¾ç½®ã€‚

### 3.2. JVM å†…å­˜é…ç½®

| é…ç½®                | æè¿°                                                         |
| ------------------- | ------------------------------------------------------------ |
| `-Xss`              | è™šæ‹Ÿæœºæ ˆå¤§å°ã€‚                                               |
| `-Xms`              | å †ç©ºé—´åˆå§‹å€¼ã€‚                                               |
| `-Xmx`              | å †ç©ºé—´æœ€å¤§å€¼ã€‚                                               |
| `-Xmn`              | æ–°ç”Ÿä»£ç©ºé—´å¤§å°ã€‚                                             |
| `-XX:NewSize`       | æ–°ç”Ÿä»£ç©ºé—´åˆå§‹å€¼ã€‚                                           |
| `-XX:MaxNewSize`    | æ–°ç”Ÿä»£ç©ºé—´æœ€å¤§å€¼ã€‚                                           |
| `-XX:NewRatio`      | æ–°ç”Ÿä»£ä¸å¹´è€ä»£çš„æ¯”ä¾‹ã€‚é»˜è®¤ä¸º 2ï¼Œæ„å‘³ç€è€å¹´ä»£æ˜¯æ–°ç”Ÿä»£çš„ 2 å€ã€‚ |
| `-XX:SurvivorRatio` | æ–°ç”Ÿä»£ä¸­è°ƒæ•´ eden åŒºä¸ survivor åŒºçš„æ¯”ä¾‹ï¼Œé»˜è®¤ä¸º 8ã€‚å³ `eden` åŒºä¸º 80% çš„å¤§å°ï¼Œä¸¤ä¸ª `survivor` åˆ†åˆ«ä¸º 10% çš„å¤§å°ã€‚ |
| `-XX:PermSize`      | æ°¸ä¹…ä»£ç©ºé—´çš„åˆå§‹å€¼ã€‚                                         |
| `-XX:MaxPermSize`   | æ°¸ä¹…ä»£ç©ºé—´çš„æœ€å¤§å€¼ã€‚                                         |

### 3.3. GC ç±»å‹é…ç½®

ä¸€èˆ¬è€Œè¨€ï¼Œ GCä¸åº”è¯¥æˆä¸ºå½±å“ç³»ç»Ÿæ€§èƒ½çš„ç“¶é¢ˆï¼Œæˆ‘ä»¬åœ¨è¯„ä¼° GCæ”¶é›†å™¨çš„ä¼˜åŠ£æ—¶ä¸€èˆ¬è€ƒè™‘ä»¥ä¸‹å‡ ç‚¹ï¼š

- ååé‡
- GCå¼€é”€
- æš‚åœæ—¶é—´
- GCé¢‘ç‡
- å †ç©ºé—´
- å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ

æ‰€ä»¥é’ˆå¯¹ä¸åŒçš„ GCæ”¶é›†å™¨ï¼Œæˆ‘ä»¬è¦å¯¹åº”æˆ‘ä»¬çš„åº”ç”¨åœºæ™¯æ¥è¿›è¡Œé€‰æ‹©å’Œè°ƒä¼˜ï¼Œå›é¡¾ GCçš„å†å²ï¼Œä¸»è¦æœ‰ 4ç§ GCæ”¶é›†å™¨: Serialã€ Parallelã€ CMSå’Œ G1ã€‚

| é…ç½®                        | æè¿°                                                 |
| --------------------------- | ---------------------------------------------------- |
| `-XX:+UseSerialGC`          | ä½¿ç”¨ Serial + Serial Old åƒåœ¾å›æ”¶å™¨ç»„åˆ              |
| `-XX:+UseParallelGC`        | ä½¿ç”¨ Parallel Scavenge + Parallel Old åƒåœ¾å›æ”¶å™¨ç»„åˆ |
| ~~`-XX:+UseParallelOldGC`~~ | ~~ä½¿ç”¨ Parallel Old åƒåœ¾å›æ”¶å™¨ï¼ˆJDK5 åå·²æ— ç”¨ï¼‰~~    |
| `-XX:+UseParNewGC`          | ä½¿ç”¨ ParNew + Serial Old åƒåœ¾å›æ”¶å™¨                  |
| `-XX:+UseConcMarkSweepGC`   | ä½¿ç”¨ CMS + ParNew + Serial Old åƒåœ¾å›æ”¶å™¨ç»„åˆ        |
| `-XX:+UseG1GC`              | ä½¿ç”¨ G1 åƒåœ¾å›æ”¶å™¨                                   |
| `-XX:ParallelCMSThreads`    | å¹¶å‘æ ‡è®°æ‰«æåƒåœ¾å›æ”¶å™¨ = ä¸ºä½¿ç”¨çš„çº¿ç¨‹æ•°é‡            |

### 3.4. åƒåœ¾å›æ”¶å™¨é€šç”¨å‚æ•°

| é…ç½®                     | æè¿°                                                         |
| ------------------------ | ------------------------------------------------------------ |
| `PretenureSizeThreshold` | æ™‹å‡å¹´è€ä»£çš„å¯¹è±¡å¤§å°ã€‚é»˜è®¤ä¸º 0ã€‚æ¯”å¦‚è®¾ä¸º 10Mï¼Œåˆ™è¶…è¿‡ 10M çš„å¯¹è±¡å°†ä¸åœ¨ eden åŒºåˆ†é…ï¼Œè€Œç›´æ¥è¿›å…¥å¹´è€ä»£ã€‚ |
| `MaxTenuringThreshold`   | æ™‹å‡è€å¹´ä»£çš„æœ€å¤§å¹´é¾„ã€‚é»˜è®¤ä¸º 15ã€‚æ¯”å¦‚è®¾ä¸º 10ï¼Œåˆ™å¯¹è±¡åœ¨ 10 æ¬¡æ™®é€š GC åå°†ä¼šè¢«æ”¾å…¥å¹´è€ä»£ã€‚ |
| `DisableExplicitGC`      | ç¦ç”¨ `System.gc()`                                           |

### 3.5. JMX

å¼€å¯ JMX åï¼Œå¯ä»¥ä½¿ç”¨ `jconsole` æˆ– `jvisualvm` è¿›è¡Œç›‘æ§ Java ç¨‹åºçš„åŸºæœ¬ä¿¡æ¯å’Œè¿è¡Œæƒ…å†µã€‚

```
-Dcom.sun.management.jmxremote=true
-Dcom.sun.management.jmxremote.ssl=false
-Dcom.sun.management.jmxremote.authenticate=false
-Djava.rmi.server.hostname=127.0.0.1
-Dcom.sun.management.jmxremote.port=18888
```

`-Djava.rmi.server.hostname` æŒ‡å®š Java ç¨‹åºè¿è¡Œçš„æœåŠ¡å™¨ï¼Œ`-Dcom.sun.management.jmxremote.port` æŒ‡å®šæœåŠ¡ç›‘å¬ç«¯å£ã€‚

### 3.6. è¿œç¨‹ DEBUG

å¦‚æœå¼€å¯ Java åº”ç”¨çš„è¿œç¨‹ Debug åŠŸèƒ½ï¼Œéœ€è¦æŒ‡å®šå¦‚ä¸‹å‚æ•°ï¼š

```
-Xdebug
-Xnoagent
-Djava.compiler=NONE
-Xrunjdwp:transport=dt_socket,address=28888,server=y,suspend=n
```

address å³ä¸ºè¿œç¨‹ debug çš„ç›‘å¬ç«¯å£ã€‚

### 3.7. HeapDump

```
-XX:-OmitStackTraceInFastThrow -XX:+HeapDumpOnOutOfMemoryError
```

### 3.8. è¾…åŠ©é…ç½®

| é…ç½®                              | æè¿°                     |
| --------------------------------- | ------------------------ |
| `-XX:+PrintGCDetails`             | æ‰“å° GC æ—¥å¿—             |
| `-Xloggc:<filename>`              | æŒ‡å®š GC æ—¥å¿—æ–‡ä»¶å       |
| `-XX:+HeapDumpOnOutOfMemoryError` | å†…å­˜æº¢å‡ºæ—¶è¾“å‡ºå †å¿«ç…§æ–‡ä»¶ |



## 4.å¸¸ç”¨å‚æ•°è®¾ç½®

### 4.1.è™šæ‹Ÿæœºå‚æ•°

| **å‚æ•°åç§°**                | **å«ä¹‰**                                                   | **é»˜è®¤å€¼**           | è§£é‡Šè¯´æ˜                                                     |
| :-------------------------- | :--------------------------------------------------------- | :------------------- | :----------------------------------------------------------- |
| -Xms                        | åˆå§‹å †å¤§å°                                                 | ç‰©ç†å†…å­˜çš„1/64(<1GB) | é»˜è®¤(MinHeapFreeRatioå‚æ•°å¯ä»¥è°ƒæ•´)ç©ºä½™å †å†…å­˜å°äº40%æ—¶ï¼ŒJVMå°±ä¼šå¢å¤§å †ç›´åˆ°-Xmxçš„æœ€å¤§é™åˆ¶. |
| -Xmx                        | æœ€å¤§å †å¤§å°                                                 | ç‰©ç†å†…å­˜çš„1/4(<1GB)  | é»˜è®¤(MaxHeapFreeRatioå‚æ•°å¯ä»¥è°ƒæ•´)ç©ºä½™å †å†…å­˜å¤§äº70%æ—¶ï¼ŒJVMä¼šå‡å°‘å †ç›´åˆ° -Xmsçš„æœ€å°é™åˆ¶ |
| -Xmn                        | å¹´è½»ä»£å¤§å°(1.4or lator)                                    |                      | **æ³¨æ„**ï¼šæ­¤å¤„çš„å¤§å°æ˜¯ï¼ˆeden+ 2 survivor space).ä¸jmap -heapä¸­æ˜¾ç¤ºçš„New genæ˜¯ä¸åŒçš„ã€‚ æ•´ä¸ªå †å¤§å°=å¹´è½»ä»£å¤§å° + å¹´è€ä»£å¤§å° + æŒä¹…ä»£å¤§å°. å¢å¤§å¹´è½»ä»£å,å°†ä¼šå‡å°å¹´è€ä»£å¤§å°.æ­¤å€¼å¯¹ç³»ç»Ÿæ€§èƒ½å½±å“è¾ƒå¤§,Sunå®˜æ–¹æ¨èé…ç½®ä¸ºæ•´ä¸ªå †çš„3/8 |
| -XX:NewSize                 | è®¾ç½®å¹´è½»ä»£å¤§å°(for 1.3/1.4)                                |                      |                                                              |
| -XX:MaxNewSize              | å¹´è½»ä»£æœ€å¤§å€¼(for 1.3/1.4)                                  |                      |                                                              |
| -XX:PermSize                | è®¾ç½®æŒä¹…ä»£(perm gen)åˆå§‹å€¼                                 | ç‰©ç†å†…å­˜çš„1/64       |                                                              |
| -XX:MaxPermSize             | è®¾ç½®æŒä¹…ä»£æœ€å¤§å€¼                                           | ç‰©ç†å†…å­˜çš„1/4        |                                                              |
| -Xss                        | æ¯ä¸ªçº¿ç¨‹çš„å †æ ˆå¤§å°                                         |                      | JDK5.0ä»¥åæ¯ä¸ªçº¿ç¨‹å †æ ˆå¤§å°ä¸º1M,ä»¥å‰æ¯ä¸ªçº¿ç¨‹å †æ ˆå¤§å°ä¸º256K.æ›´å…·åº”ç”¨çš„çº¿ç¨‹æ‰€éœ€å†…å­˜å¤§å°è¿›è¡Œ è°ƒæ•´.åœ¨ç›¸åŒç‰©ç†å†…å­˜ä¸‹,å‡å°è¿™ä¸ªå€¼èƒ½ç”Ÿæˆæ›´å¤šçš„çº¿ç¨‹.ä½†æ˜¯æ“ä½œç³»ç»Ÿå¯¹ä¸€ä¸ªè¿›ç¨‹å†…çš„çº¿ç¨‹æ•°è¿˜æ˜¯æœ‰é™åˆ¶çš„,ä¸èƒ½æ— é™ç”Ÿæˆ,ç»éªŒå€¼åœ¨3000~5000å·¦å³ ä¸€èˆ¬å°çš„åº”ç”¨ï¼Œ å¦‚æœæ ˆä¸æ˜¯å¾ˆæ·±ï¼Œ åº”è¯¥æ˜¯128kå¤Ÿç”¨çš„ å¤§çš„åº”ç”¨å»ºè®®ä½¿ç”¨256kã€‚è¿™ä¸ªé€‰é¡¹å¯¹æ€§èƒ½å½±å“æ¯”è¾ƒå¤§ï¼Œéœ€è¦ä¸¥æ ¼çš„æµ‹è¯•ã€‚ å’Œthreadstacksizeé€‰é¡¹è§£é‡Šå¾ˆç±»ä¼¼,å®˜æ–¹æ–‡æ¡£ä¼¼ä¹æ²¡æœ‰è§£é‡Š,åœ¨è®ºå›ä¸­æœ‰è¿™æ ·ä¸€å¥è¯:"â€ -Xss is translated in a VM flag named ThreadStackSizeâ€ ä¸€èˆ¬è®¾ç½®è¿™ä¸ªå€¼å°±å¯ä»¥äº†ã€‚ |
| -*XX:ThreadStackSize*       | Thread Stack Size                                          |                      | (0 means use default stack size) [Sparc: 512; Solaris x86: 320 (was 256 prior in 5.0 and earlier); Sparc 64 bit: 1024; Linux amd64: 1024 (was 0 in 5.0 and earlier); all others 0.] |
| -XX:NewRatio                | å¹´è½»ä»£(åŒ…æ‹¬Edenå’Œä¸¤ä¸ªSurvivoråŒº)ä¸å¹´è€ä»£çš„æ¯”å€¼(é™¤å»æŒä¹…ä»£) |                      | -XX:NewRatio=4è¡¨ç¤ºå¹´è½»ä»£ä¸å¹´è€ä»£æ‰€å æ¯”å€¼ä¸º1:4,å¹´è½»ä»£å æ•´ä¸ªå †æ ˆçš„1/5 Xms=Xmxå¹¶ä¸”è®¾ç½®äº†Xmnçš„æƒ…å†µä¸‹ï¼Œè¯¥å‚æ•°ä¸éœ€è¦è¿›è¡Œè®¾ç½®ã€‚ |
| -XX:SurvivorRatio           | EdenåŒºä¸SurvivoråŒºçš„å¤§å°æ¯”å€¼                               |                      | è®¾ç½®ä¸º8,åˆ™ä¸¤ä¸ªSurvivoråŒºä¸ä¸€ä¸ªEdenåŒºçš„æ¯”å€¼ä¸º2:8,ä¸€ä¸ªSurvivoråŒºå æ•´ä¸ªå¹´è½»ä»£çš„1/10 |
| -XX:LargePageSizeInBytes    | å†…å­˜é¡µçš„å¤§å°ä¸å¯è®¾ç½®è¿‡å¤§ï¼Œ ä¼šå½±å“Permçš„å¤§å°                |                      | =128m                                                        |
| -XX:+UseFastAccessorMethods | åŸå§‹ç±»å‹çš„å¿«é€Ÿä¼˜åŒ–                                         |                      |                                                              |
| -XX:+DisableExplicitGC      | å…³é—­System.gc()                                            |                      | è¿™ä¸ªå‚æ•°éœ€è¦ä¸¥æ ¼çš„æµ‹è¯•                                       |
| -XX:MaxTenuringThreshold    | åƒåœ¾æœ€å¤§å¹´é¾„                                               |                      | å¦‚æœè®¾ç½®ä¸º0çš„è¯,åˆ™å¹´è½»ä»£å¯¹è±¡ä¸ç»è¿‡SurvivoråŒº,ç›´æ¥è¿›å…¥å¹´è€ä»£. å¯¹äºå¹´è€ä»£æ¯”è¾ƒå¤šçš„åº”ç”¨,å¯ä»¥æé«˜æ•ˆç‡.å¦‚æœå°†æ­¤å€¼è®¾ç½®ä¸ºä¸€ä¸ªè¾ƒå¤§å€¼,åˆ™å¹´è½»ä»£å¯¹è±¡ä¼šåœ¨SurvivoråŒºè¿›è¡Œå¤šæ¬¡å¤åˆ¶,è¿™æ ·å¯ä»¥å¢åŠ å¯¹è±¡å†å¹´è½»ä»£çš„å­˜æ´» æ—¶é—´,å¢åŠ åœ¨å¹´è½»ä»£å³è¢«å›æ”¶çš„æ¦‚ç‡ è¯¥å‚æ•°åªæœ‰åœ¨ä¸²è¡ŒGCæ—¶æ‰æœ‰æ•ˆ. |
| -XX:+AggressiveOpts         | åŠ å¿«ç¼–è¯‘                                                   |                      |                                                              |
| -XX:+UseBiasedLocking       | é”æœºåˆ¶çš„æ€§èƒ½æ”¹å–„                                           |                      |                                                              |
| -Xnoclassgc                 | ç¦ç”¨åƒåœ¾å›æ”¶                                               |                      |                                                              |
| -XX:SoftRefLRUPolicyMSPerMB | æ¯å…†å †ç©ºé—²ç©ºé—´ä¸­SoftReferenceçš„å­˜æ´»æ—¶é—´                    | 1s                   | softly reachable objects will remain alive for some amount of time after the last time they were referenced. The default value is one second of lifetime per free megabyte in the heap |
| -XX:PretenureSizeThreshold  | å¯¹è±¡è¶…è¿‡å¤šå¤§æ˜¯ç›´æ¥åœ¨æ—§ç”Ÿä»£åˆ†é…                             | 0                    | å•ä½å­—èŠ‚ æ–°ç”Ÿä»£é‡‡ç”¨Parallel Scavenge GCæ—¶æ— æ•ˆ å¦ä¸€ç§ç›´æ¥åœ¨æ—§ç”Ÿä»£åˆ†é…çš„æƒ…å†µæ˜¯å¤§çš„æ•°ç»„å¯¹è±¡,ä¸”æ•°ç»„ä¸­æ— å¤–éƒ¨å¼•ç”¨å¯¹è±¡. |
| -XX:TLABWasteTargetPercent  | TLABå edenåŒºçš„ç™¾åˆ†æ¯”                                       | 1%                   |                                                              |
| -XX:+*CollectGen0First*     | FullGCæ—¶æ˜¯å¦å…ˆYGC                                          | false                |                                                              |

### 4.2.å¹¶è¡Œæ”¶é›†å™¨ç›¸å…³å‚æ•°

| **å‚æ•°åç§°**                | **å«ä¹‰**                                          | **é»˜è®¤å€¼** | è§£é‡Šè¯´æ˜                                                     |
| :-------------------------- | :------------------------------------------------ | :--------- | :----------------------------------------------------------- |
| -XX:+UseParallelGC          | Full GCé‡‡ç”¨parallel MSC (æ­¤é¡¹å¾…éªŒè¯)              |            | é€‰æ‹©åƒåœ¾æ”¶é›†å™¨ä¸ºå¹¶è¡Œæ”¶é›†å™¨.æ­¤é…ç½®ä»…å¯¹å¹´è½»ä»£æœ‰æ•ˆ.å³ä¸Šè¿°é…ç½®ä¸‹,å¹´è½»ä»£ä½¿ç”¨å¹¶å‘æ”¶é›†,è€Œå¹´è€ä»£ä»æ—§ä½¿ç”¨ä¸²è¡Œæ”¶é›†.(æ­¤é¡¹å¾…éªŒè¯) |
| -XX:+UseParNewGC            | è®¾ç½®å¹´è½»ä»£ä¸ºå¹¶è¡Œæ”¶é›†                              |            | å¯ä¸CMSæ”¶é›†åŒæ—¶ä½¿ç”¨ JDK5.0ä»¥ä¸Š,JVMä¼šæ ¹æ®ç³»ç»Ÿé…ç½®è‡ªè¡Œè®¾ç½®,æ‰€ä»¥æ— éœ€å†è®¾ç½®æ­¤å€¼ |
| -XX:ParallelGCThreads       | å¹¶è¡Œæ”¶é›†å™¨çš„çº¿ç¨‹æ•°                                |            | æ­¤å€¼æœ€å¥½é…ç½®ä¸å¤„ç†å™¨æ•°ç›®ç›¸ç­‰ åŒæ ·é€‚ç”¨äºCMS                   |
| -XX:+UseParallelOldGC       | å¹´è€ä»£åƒåœ¾æ”¶é›†æ–¹å¼ä¸ºå¹¶è¡Œæ”¶é›†(Parallel Compacting) |            | è¿™ä¸ªæ˜¯JAVA 6å‡ºç°çš„å‚æ•°é€‰é¡¹                                   |
| -XX:MaxGCPauseMillis        | æ¯æ¬¡å¹´è½»ä»£åƒåœ¾å›æ”¶çš„æœ€é•¿æ—¶é—´(æœ€å¤§æš‚åœæ—¶é—´)        |            | å¦‚æœæ— æ³•æ»¡è¶³æ­¤æ—¶é—´,JVMä¼šè‡ªåŠ¨è°ƒæ•´å¹´è½»ä»£å¤§å°,ä»¥æ»¡è¶³æ­¤å€¼.       |
| -XX:+UseAdaptiveSizePolicy  | è‡ªåŠ¨é€‰æ‹©å¹´è½»ä»£åŒºå¤§å°å’Œç›¸åº”çš„SurvivoråŒºæ¯”ä¾‹        |            | è®¾ç½®æ­¤é€‰é¡¹å,å¹¶è¡Œæ”¶é›†å™¨ä¼šè‡ªåŠ¨é€‰æ‹©å¹´è½»ä»£åŒºå¤§å°å’Œç›¸åº”çš„SurvivoråŒºæ¯”ä¾‹,ä»¥è¾¾åˆ°ç›®æ ‡ç³»ç»Ÿè§„å®šçš„æœ€ä½ç›¸åº”æ—¶é—´æˆ–è€…æ”¶é›†é¢‘ç‡ç­‰,æ­¤å€¼å»ºè®®ä½¿ç”¨å¹¶è¡Œæ”¶é›†å™¨æ—¶,ä¸€ç›´æ‰“å¼€. |
| -XX:GCTimeRatio             | è®¾ç½®åƒåœ¾å›æ”¶æ—¶é—´å ç¨‹åºè¿è¡Œæ—¶é—´çš„ç™¾åˆ†æ¯”            |            | å…¬å¼ä¸º1/(1+n)                                                |
| -XX:+*ScavengeBeforeFullGC* | Full GCå‰è°ƒç”¨YGC                                  | true       | Do young generation GC prior to a full GC. (Introduced in 1.4.1.) |

### 4.3.CMSå¤„ç†å™¨å‚æ•°è®¾ç½®

| **å‚æ•°åç§°**                           | **å«ä¹‰**                                  | **é»˜è®¤å€¼** | è§£é‡Šè¯´æ˜                                                     |
| :------------------------------------- | :---------------------------------------- | :--------- | :----------------------------------------------------------- |
| -XX:+UseConcMarkSweepGC                | ä½¿ç”¨CMSå†…å­˜æ”¶é›†                           |            | æµ‹è¯•ä¸­é…ç½®è¿™ä¸ªä»¥å,-XX:NewRatio=4çš„é…ç½®å¤±æ•ˆäº†,åŸå› ä¸æ˜.æ‰€ä»¥,æ­¤æ—¶å¹´è½»ä»£å¤§å°æœ€å¥½ç”¨-Xmnè®¾ç½®.??? |
| -XX:+AggressiveHeap                    |                                           |            | è¯•å›¾æ˜¯ä½¿ç”¨å¤§é‡çš„ç‰©ç†å†…å­˜ é•¿æ—¶é—´å¤§å†…å­˜ä½¿ç”¨çš„ä¼˜åŒ–ï¼Œèƒ½æ£€æŸ¥è®¡ç®—èµ„æºï¼ˆå†…å­˜ï¼Œ å¤„ç†å™¨æ•°é‡ï¼‰ è‡³å°‘éœ€è¦256MBå†…å­˜ å¤§é‡çš„CPUï¼å†…å­˜ï¼Œ ï¼ˆåœ¨1.4.1åœ¨4CPUçš„æœºå™¨ä¸Šå·²ç»æ˜¾ç¤ºæœ‰æå‡ï¼‰ |
| -XX:CMSFullGCsBeforeCompaction         | å¤šå°‘æ¬¡åè¿›è¡Œå†…å­˜å‹ç¼©                      |            | ç”±äºå¹¶å‘æ”¶é›†å™¨ä¸å¯¹å†…å­˜ç©ºé—´è¿›è¡Œå‹ç¼©,æ•´ç†,æ‰€ä»¥è¿è¡Œä¸€æ®µæ—¶é—´ä»¥åä¼šäº§ç”Ÿ"ç¢ç‰‡",ä½¿å¾—è¿è¡Œæ•ˆç‡é™ä½.æ­¤å€¼è®¾ç½®è¿è¡Œå¤šå°‘æ¬¡GCä»¥åå¯¹å†…å­˜ç©ºé—´è¿›è¡Œå‹ç¼©,æ•´ç†. |
| -XX:+CMSParallelRemarkEnabled          | é™ä½æ ‡è®°åœé¡¿                              |            |                                                              |
| -XX+UseCMSCompactAtFullCollection      | åœ¨FULL GCçš„æ—¶å€™ï¼Œ å¯¹å¹´è€ä»£çš„å‹ç¼©          |            | CMSæ˜¯ä¸ä¼šç§»åŠ¨å†…å­˜çš„ï¼Œ å› æ­¤ï¼Œ è¿™ä¸ªéå¸¸å®¹æ˜“äº§ç”Ÿç¢ç‰‡ï¼Œ å¯¼è‡´å†…å­˜ä¸å¤Ÿç”¨ï¼Œ å› æ­¤ï¼Œ å†…å­˜çš„å‹ç¼©è¿™ä¸ªæ—¶å€™å°±ä¼šè¢«å¯ç”¨ã€‚ å¢åŠ è¿™ä¸ªå‚æ•°æ˜¯ä¸ªå¥½ä¹ æƒ¯ã€‚ å¯èƒ½ä¼šå½±å“æ€§èƒ½,ä½†æ˜¯å¯ä»¥æ¶ˆé™¤ç¢ç‰‡ |
| -XX:+UseCMSInitiatingOccupancyOnly     | ä½¿ç”¨æ‰‹åŠ¨å®šä¹‰åˆå§‹åŒ–å®šä¹‰å¼€å§‹CMSæ”¶é›†         |            | ç¦æ­¢hostspotè‡ªè¡Œè§¦å‘CMS GC                                   |
| -XX:CMSInitiatingOccupancyFraction=70  | ä½¿ç”¨cmsä½œä¸ºåƒåœ¾å›æ”¶ ä½¿ç”¨70ï¼…åå¼€å§‹CMSæ”¶é›† | 92         | ä¸ºäº†ä¿è¯ä¸å‡ºç°promotion failed(è§ä¸‹é¢ä»‹ç»)é”™è¯¯,è¯¥å€¼çš„è®¾ç½®éœ€è¦æ»¡è¶³ä»¥ä¸‹å…¬å¼**[CMSInitiatingOccupancyFractionè®¡ç®—å…¬å¼](http://www.cnblogs.com/redcreen/archive/2011/05/04/2037057.html#CMSInitiatingOccupancyFraction_value)** |
| -XX:CMSInitiatingPermOccupancyFraction | è®¾ç½®Perm Genä½¿ç”¨åˆ°è¾¾å¤šå°‘æ¯”ç‡æ—¶è§¦å‘        | 92         |                                                              |
| -XX:+CMSIncrementalMode                | è®¾ç½®ä¸ºå¢é‡æ¨¡å¼                            |            | ç”¨äºå•CPUæƒ…å†µ                                                |
| -XX:+CMSClassUnloadingEnabled          |                                           |            |                                                              |

### 4.4.JVMè¾…åŠ©ä¿¡æ¯å‚æ•°è®¾ç½®

| **å‚æ•°åç§°**                          | **å«ä¹‰**                                                 | **é»˜è®¤å€¼** | è§£é‡Šè¯´æ˜                                                     |
| :------------------------------------ | :------------------------------------------------------- | :--------- | :----------------------------------------------------------- |
| -XX:+PrintGC                          |                                                          |            | è¾“å‡ºå½¢å¼:[GC 118250K->113543K(130112K), 0.0094143 secs] [Full GC 121376K->10414K(130112K), 0.0650971 secs] |
| -XX:+PrintGCDetails                   |                                                          |            | è¾“å‡ºå½¢å¼:[GC [DefNew: 8614K->781K(9088K), 0.0123035 secs] 118250K->113543K(130112K), 0.0124633 secs] [GC [DefNew: 8614K->8614K(9088K), 0.0000665 secs][Tenured: 112761K->10414K(121024K), 0.0433488 secs] 121376K->10414K(130112K), 0.0436268 secs] |
| -XX:+PrintGCTimeStamps                |                                                          |            |                                                              |
| -XX:+PrintGC:PrintGCTimeStamps        |                                                          |            | å¯ä¸-XX:+PrintGC -XX:+PrintGCDetailsæ··åˆä½¿ç”¨ è¾“å‡ºå½¢å¼:11.851: [GC 98328K->93620K(130112K), 0.0082960 secs] |
| -XX:+PrintGCApplicationStoppedTime    | æ‰“å°åƒåœ¾å›æ”¶æœŸé—´ç¨‹åºæš‚åœçš„æ—¶é—´.å¯ä¸ä¸Šé¢æ··åˆä½¿ç”¨          |            | è¾“å‡ºå½¢å¼:Total time for which application threads were stopped: 0.0468229 seconds |
| -XX:+PrintGCApplicationConcurrentTime | æ‰“å°æ¯æ¬¡åƒåœ¾å›æ”¶å‰,ç¨‹åºæœªä¸­æ–­çš„æ‰§è¡Œæ—¶é—´.å¯ä¸ä¸Šé¢æ··åˆä½¿ç”¨ |            | è¾“å‡ºå½¢å¼:Application time: 0.5291524 seconds                 |
| -XX:+PrintHeapAtGC                    | æ‰“å°GCå‰åçš„è¯¦ç»†å †æ ˆä¿¡æ¯                                 |            |                                                              |
| -Xloggc:filename                      | æŠŠç›¸å…³æ—¥å¿—ä¿¡æ¯è®°å½•åˆ°æ–‡ä»¶ä»¥ä¾¿åˆ†æ. ä¸ä¸Šé¢å‡ ä¸ªé…åˆä½¿ç”¨     |            |                                                              |
| -XX:+PrintClassHistogram              | garbage collects before printing the histogram.          |            |                                                              |
| -XX:+PrintTLAB                        | æŸ¥çœ‹TLABç©ºé—´çš„ä½¿ç”¨æƒ…å†µ                                   |            |                                                              |
| XX:+PrintTenuringDistribution         | æŸ¥çœ‹æ¯æ¬¡minor GCåæ–°çš„å­˜æ´»å‘¨æœŸçš„é˜ˆå€¼                     |            | Desired survivor size 1048576 bytes, new threshold 7 (max 15) new threshold 7å³æ ‡è¯†æ–°çš„å­˜æ´»å‘¨æœŸçš„é˜ˆå€¼ä¸º7ã€‚ |

### 4.5.JVM GCåƒåœ¾å›æ”¶å™¨å‚æ•°è®¾ç½®

JVMç»™å‡ºäº†3ç§é€‰æ‹©ï¼š**ä¸²è¡Œæ”¶é›†å™¨**ã€**å¹¶è¡Œæ”¶é›†å™¨**ã€**å¹¶å‘æ”¶é›†å™¨**ã€‚ä¸²è¡Œæ”¶é›†å™¨åªé€‚ç”¨äºå°æ•°æ®é‡çš„æƒ…å†µï¼Œæ‰€ä»¥ç”Ÿäº§ç¯å¢ƒçš„é€‰æ‹©ä¸»è¦æ˜¯å¹¶è¡Œæ”¶é›†å™¨å’Œå¹¶å‘æ”¶é›†å™¨ã€‚é»˜è®¤æƒ…å†µä¸‹JDK5.0ä»¥å‰éƒ½æ˜¯ä½¿ç”¨ä¸²è¡Œæ”¶é›†å™¨ï¼Œå¦‚æœæƒ³ä½¿ç”¨å…¶ä»–æ”¶é›†å™¨éœ€è¦åœ¨å¯åŠ¨æ—¶åŠ å…¥ç›¸åº”å‚æ•°ã€‚JDK5.0ä»¥åï¼ŒJVMä¼šæ ¹æ®å½“å‰ç³»ç»Ÿé…ç½®è¿›è¡Œæ™ºèƒ½åˆ¤æ–­ã€‚

**ä¸²è¡Œæ”¶é›†å™¨**
-XX:+UseSerialGCï¼šè®¾ç½®ä¸²è¡Œæ”¶é›†å™¨ã€‚

**å¹¶è¡Œæ”¶é›†å™¨ï¼ˆååé‡ä¼˜å…ˆï¼‰**
-XX:+UseParallelGCï¼šè®¾ç½®ä¸ºå¹¶è¡Œæ”¶é›†å™¨ã€‚æ­¤é…ç½®ä»…å¯¹å¹´è½»ä»£æœ‰æ•ˆã€‚å³å¹´è½»ä»£ä½¿ç”¨å¹¶è¡Œæ”¶é›†ï¼Œè€Œå¹´è€ä»£ä»ä½¿ç”¨ä¸²è¡Œæ”¶é›†ã€‚

-XX:ParallelGCThreads=20ï¼šé…ç½®å¹¶è¡Œæ”¶é›†å™¨çš„çº¿ç¨‹æ•°ï¼Œå³ï¼šåŒæ—¶æœ‰å¤šå°‘ä¸ªçº¿ç¨‹ä¸€èµ·è¿›è¡Œåƒåœ¾å›æ”¶ã€‚æ­¤å€¼å»ºè®®é…ç½®ä¸CPUæ•°ç›®ç›¸ç­‰ã€‚

-XX:+UseParallelOldGCï¼šé…ç½®å¹´è€ä»£åƒåœ¾æ”¶é›†æ–¹å¼ä¸ºå¹¶è¡Œæ”¶é›†ã€‚JDK6.0å¼€å§‹æ”¯æŒå¯¹å¹´è€ä»£å¹¶è¡Œæ”¶é›†ã€‚

-XX:MaxGCPauseMillis=100ï¼šè®¾ç½®æ¯æ¬¡å¹´è½»ä»£åƒåœ¾å›æ”¶çš„æœ€é•¿æ—¶é—´ï¼ˆå•ä½æ¯«ç§’ï¼‰ã€‚å¦‚æœæ— æ³•æ»¡è¶³æ­¤æ—¶é—´ï¼ŒJVMä¼šè‡ªåŠ¨è°ƒæ•´å¹´è½»ä»£å¤§å°ï¼Œä»¥æ»¡è¶³æ­¤æ—¶é—´ã€‚

-XX:+UseAdaptiveSizePolicyï¼šè®¾ç½®æ­¤é€‰é¡¹åï¼Œå¹¶è¡Œæ”¶é›†å™¨ä¼šè‡ªåŠ¨è°ƒæ•´å¹´è½»ä»£EdenåŒºå¤§å°å’ŒSurvivoråŒºå¤§å°çš„æ¯”ä¾‹ï¼Œä»¥è¾¾æˆç›®æ ‡ç³»ç»Ÿè§„å®šçš„æœ€ä½å“åº”æ—¶é—´æˆ–è€…æ”¶é›†é¢‘ç‡ç­‰æŒ‡æ ‡ã€‚æ­¤å‚æ•°å»ºè®®åœ¨ä½¿ç”¨å¹¶è¡Œæ”¶é›†å™¨æ—¶ï¼Œä¸€ç›´æ‰“å¼€ã€‚
å¹¶å‘æ”¶é›†å™¨ï¼ˆå“åº”æ—¶é—´ä¼˜å…ˆï¼‰

**å¹¶è¡Œæ”¶é›†å™¨**

-XX:+UseConcMarkSweepGCï¼šå³CMSæ”¶é›†ï¼Œè®¾ç½®å¹´è€ä»£ä¸ºå¹¶å‘æ”¶é›†ã€‚CMSæ”¶é›†æ˜¯JDK1.4åæœŸç‰ˆæœ¬å¼€å§‹å¼•å…¥çš„æ–°GCç®—æ³•ã€‚å®ƒçš„ä¸»è¦é€‚åˆåœºæ™¯æ˜¯å¯¹å“åº”æ—¶é—´çš„é‡è¦æ€§éœ€æ±‚å¤§äºå¯¹ååé‡çš„éœ€æ±‚ï¼Œèƒ½å¤Ÿæ‰¿å—åƒåœ¾å›æ”¶çº¿ç¨‹å’Œåº”ç”¨çº¿ç¨‹å…±äº«CPUèµ„æºï¼Œå¹¶ä¸”åº”ç”¨ä¸­å­˜åœ¨æ¯”è¾ƒå¤šçš„é•¿ç”Ÿå‘½å‘¨æœŸå¯¹è±¡ã€‚CMSæ”¶é›†çš„ç›®æ ‡æ˜¯å°½é‡å‡å°‘åº”ç”¨çš„æš‚åœæ—¶é—´ï¼Œå‡å°‘Full GCå‘ç”Ÿçš„å‡ ç‡ï¼Œåˆ©ç”¨å’Œåº”ç”¨ç¨‹åºçº¿ç¨‹å¹¶å‘çš„åƒåœ¾å›æ”¶çº¿ç¨‹æ¥æ ‡è®°æ¸…é™¤å¹´è€ä»£å†…å­˜ã€‚

-XX:+UseParNewGCï¼šè®¾ç½®å¹´è½»ä»£ä¸ºå¹¶å‘æ”¶é›†ã€‚å¯ä¸CMSæ”¶é›†åŒæ—¶ä½¿ç”¨ã€‚JDK5.0ä»¥ä¸Šï¼ŒJVMä¼šæ ¹æ®ç³»ç»Ÿé…ç½®è‡ªè¡Œè®¾ç½®ï¼Œæ‰€ä»¥æ— éœ€å†è®¾ç½®æ­¤å‚æ•°ã€‚

-XX:CMSFullGCsBeforeCompaction=0ï¼šç”±äºå¹¶å‘æ”¶é›†å™¨ä¸å¯¹å†…å­˜ç©ºé—´è¿›è¡Œå‹ç¼©å’Œæ•´ç†ï¼Œæ‰€ä»¥è¿è¡Œä¸€æ®µæ—¶é—´å¹¶è¡Œæ”¶é›†ä»¥åä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ï¼Œå†…å­˜ä½¿ç”¨æ•ˆç‡é™ä½ã€‚æ­¤å‚æ•°è®¾ç½®è¿è¡Œ0æ¬¡Full GCåå¯¹å†…å­˜ç©ºé—´è¿›è¡Œå‹ç¼©å’Œæ•´ç†ï¼Œå³æ¯æ¬¡Full GCåç«‹åˆ»å¼€å§‹å‹ç¼©å’Œæ•´ç†å†…å­˜ã€‚

-XX:+UseCMSCompactAtFullCollectionï¼šæ‰“å¼€å†…å­˜ç©ºé—´çš„å‹ç¼©å’Œæ•´ç†ï¼Œåœ¨Full GCåæ‰§è¡Œã€‚å¯èƒ½ä¼šå½±å“æ€§èƒ½ï¼Œä½†å¯ä»¥æ¶ˆé™¤å†…å­˜ç¢ç‰‡ã€‚

-XX:+CMSIncrementalModeï¼šè®¾ç½®ä¸ºå¢é‡æ”¶é›†æ¨¡å¼ã€‚ä¸€èˆ¬é€‚ç”¨äºå•CPUæƒ…å†µã€‚

-XX:CMSInitiatingOccupancyFraction=70ï¼šè¡¨ç¤ºå¹´è€ä»£å†…å­˜ç©ºé—´ä½¿ç”¨åˆ°70%æ—¶å°±å¼€å§‹æ‰§è¡ŒCMSæ”¶é›†ï¼Œä»¥ç¡®ä¿å¹´è€ä»£æœ‰è¶³å¤Ÿçš„ç©ºé—´æ¥çº³æ¥è‡ªå¹´è½»ä»£çš„å¯¹è±¡ï¼Œé¿å…Full GCçš„å‘ç”Ÿã€‚

**å…¶å®ƒåƒåœ¾å›æ”¶å‚æ•°**

-XX:+ScavengeBeforeFullGCï¼šå¹´è½»ä»£GCä¼˜äºFull GCæ‰§è¡Œã€‚

-XX:-DisableExplicitGCï¼šä¸å“åº” System.gc() ä»£ç ã€‚

-XX:+UseThreadPrioritiesï¼šå¯ç”¨æœ¬åœ°çº¿ç¨‹ä¼˜å…ˆçº§APIã€‚å³ä½¿ java.lang.Thread.setPriority() ç”Ÿæ•ˆï¼Œä¸å¯ç”¨åˆ™æ— æ•ˆã€‚

-XX:SoftRefLRUPolicyMSPerMB=0ï¼šè½¯å¼•ç”¨å¯¹è±¡åœ¨æœ€åä¸€æ¬¡è¢«è®¿é—®åèƒ½å­˜æ´»0æ¯«ç§’ï¼ˆJVMé»˜è®¤ä¸º1000æ¯«ç§’ï¼‰ã€‚

-XX:TargetSurvivorRatio=90ï¼šå…è®¸90%çš„SurvivoråŒºè¢«å ç”¨ï¼ˆJVMé»˜è®¤ä¸º50%ï¼‰ã€‚æé«˜å¯¹äºSurvivoråŒºçš„ä½¿ç”¨ç‡ã€‚

### 4.6.JVMå‚æ•°ä¼˜å…ˆçº§

-Xmnï¼Œ-XX:NewSize/-XX:MaxNewSizeï¼Œ-XX:NewRatio 3ç»„å‚æ•°éƒ½å¯ä»¥å½±å“å¹´è½»ä»£çš„å¤§å°ï¼Œæ··åˆä½¿ç”¨çš„æƒ…å†µä¸‹ï¼Œä¼˜å…ˆçº§æ˜¯ä»€ä¹ˆï¼Ÿ

ç­”æ¡ˆå¦‚ä¸‹ï¼š

> é«˜ä¼˜å…ˆçº§ï¼š-XX:NewSize/-XX:MaxNewSize
> ä¸­ä¼˜å…ˆçº§ï¼š-Xmnï¼ˆé»˜è®¤ç­‰æ•ˆ -Xmn=-XX:NewSize=-XX:MaxNewSize=?ï¼‰
> ä½ä¼˜å…ˆçº§ï¼š-XX:NewRatio
>
> æ¨èä½¿ç”¨-Xmnå‚æ•°ï¼ŒåŸå› æ˜¯è¿™ä¸ªå‚æ•°ç®€æ´ï¼Œç›¸å½“äºä¸€æ¬¡è®¾å®š NewSize/MaxNewSIzeï¼Œè€Œä¸”ä¸¤è€…ç›¸ç­‰ï¼Œé€‚ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚-Xmn é…åˆ -Xms/-Xmxï¼Œå³å¯å°†å †å†…å­˜å¸ƒå±€å®Œæˆã€‚
>
> -Xmnå‚æ•°æ˜¯åœ¨JDK 1.4 å¼€å§‹æ”¯æŒã€‚

ä¸‹é¢ç”¨ä¸€äº›å°æ¡ˆä¾‹åŠ æ·±ç†è§£:

HelloGCæ˜¯javaä»£ç ç¼–è¯‘åçš„ä¸€ä¸ªclassæ–‡ä»¶,ä»£ç :

```
public class T01_HelloGC {
    public static void main(String[] args) {

        for(int i=0; i<10000; i++) {
            byte[] b = new byte[1024 * 1024];
        }
    }
}
```

1.java -XX:+PrintCommandLineFlags HelloGC

```
[root@localhost courage]# java -XX:+PrintCommandLineFlags T01_HelloGC
-XX:InitialHeapSize=61780800 -XX:MaxHeapSize=988492800 -XX:+PrintCommandLineFlags -XX
:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseParallelGC 
```

2.

```
java -Xmn10M -Xms40M -Xmx60M -XX:+PrintCommandLineFlags -XX:+PrintGC  HelloGC
PrintGCDetails PrintGCTimeStamps PrintGCCauses
```

ç»“æœ:

```
-XX:InitialHeapSize=41943040 -XX:MaxHeapSize=62914560 -XX:MaxNewSize=10485760 -XX:NewSize=10485760 -XX:+PrintCommandLineFlags -XX:+PrintGC -XX:+UseCompressedClassPointers -XX:+UseCompressedOops 
-XX:+UseParallelGC[GC (Allocation Failure)  7839K->392K(39936K), 0.0015452 secs]
[GC (Allocation Failure)  7720K->336K(39936K), 0.0005439 secs]
[GC (Allocation Failure)  7656K->336K(39936K), 0.0005749 secs]
[GC (Allocation Failure)  7659K->368K(39936K), 0.0005095 secs]
[GC (Allocation Failure)  7693K->336K(39936K), 0.0004385 secs]
[GC (Allocation Failure)  7662K->304K(40448K), 0.0028468 secs]
......
```

å‘½ä»¤è§£é‡Š:

> java:è¡¨ç¤ºä½¿ç”¨javaæ‰§è¡Œå™¨æ‰§è¡Œ
> -Xmn10M :è¡¨ç¤ºè®¾ç½®å¹´è½»ä»£å€¼ä¸º10M
> -Xms40M :è¡¨ç¤ºè®¾ç½®å †å†…å­˜çš„æœ€å°Heapå€¼ä¸º40M
> -Xmx60M :è¡¨ç¤ºè®¾ç½®å †å†…å­˜çš„æœ€å¤§Heapå€¼ä¸º60M
> -XX:+PrintCommandLineFlags:æ‰“å°æ˜¾å¼éšå¼å‚æ•°,å°±æ˜¯ç»“æœå‰ä¸‰è¡Œ
> -XX:+PrintGC : æ‰“å°åƒåœ¾å›æ”¶æœ‰å…³ä¿¡æ¯
> HelloGC :è¿™æ˜¯éœ€è¦æ‰§è¡Œçš„å¯åŠ¨ç±»
> PrintGCDetails :æ‰“å°GCè¯¦ç»†ä¿¡æ¯
> PrintGCTimeStamps :æ‰“å°GCæ—¶é—´æˆ³
> PrintGCCauses	:æ‰“å°GCäº§ç”Ÿçš„åŸå› 

ç»“æœè§£é‡Š:

[![img](https://homan-blog.oss-cn-beijing.aliyuncs.com/study-demo/jvm-demo/20210328155751.png)](https://img2020.cnblogs.com/blog/2002319/202102/2002319-20210208103357164-1086413610.png)

3.`java -XX:+UseConcMarkSweepGC -XX:+PrintCommandLineFlags HelloGC`

è¡¨ç¤ºä½¿ç”¨CMSåƒåœ¾æ”¶é›†å™¨,åŒæ—¶æ‰“å°å‚æ•°
æ‰“å°ç»“æœ:

```
-XX:InitialHeapSize=61780800 
-XX:MaxHeapSize=988492800 
-XX:MaxNewSize=329252864 
-XX:MaxTenuringThreshold=6 
-XX:OldPLABSize=16 
-XX:+PrintCommandLineFlags 
-XX:+UseCompressedClassPointers 
-XX:+UseCompressedOops 
-XX:+UseConcMarkSweepGC 
-XX:+UseParNewGC
```

1. java -XX:+PrintFlagsInitial é»˜è®¤å‚æ•°å€¼
2. java -XX:+PrintFlagsFinal æœ€ç»ˆå‚æ•°å€¼
3. java -XX:+PrintFlagsFinal | grep xxx æ‰¾åˆ°å¯¹åº”çš„å‚æ•°
4. java -XX:+PrintFlagsFinal -version |grep GC



## JVMè°ƒä¼˜æµç¨‹

JVMè°ƒä¼˜,è®¾è®¡åˆ°ä¸‰ä¸ªå¤§çš„æ–¹é¢,åœ¨æœåŠ¡å™¨å‡ºç°é—®é¢˜ä¹‹å‰è¦å…ˆæ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©åˆé€‚çš„åƒåœ¾å¤„ç†å™¨,è®¾ç½®ä¸åŒçš„è™šæ‹Ÿæœºå‚æ•°,è¿è¡Œä¸­è§‚å¯ŸGCæ—¥å¿—,åˆ†ææ€§èƒ½,åˆ†æé—®é¢˜å®šä½é—®é¢˜,è™šæ‹Ÿæœºæ’é”™ç­‰å†…å®¹,å¦‚æœæœåŠ¡å™¨æŒ‚æ‰äº†,è¦åŠæ—¶ç”Ÿæˆæ—¥å¿—æ–‡ä»¶ä¾¿äºæ‰¾åˆ°é—®é¢˜æ‰€åœ¨ã€‚

### è°ƒä¼˜å‰çš„åŸºç¡€æ¦‚å¿µ

ç›®å‰çš„åƒåœ¾å¤„ç†å™¨ä¸­,ä¸€ç±»æ˜¯ä»¥ååé‡ä¼˜å…ˆ,ä¸€ç±»æ˜¯ä»¥å“åº”æ—¶é—´ä¼˜å…ˆ:

ååé‡=ç”¨æˆ·ä»£ç æ‰§è¡Œæ—¶é—´ç”¨æˆ·ä»£ç æ‰§è¡Œæ—¶é—´+åƒåœ¾å›æ”¶æ‰§è¡Œæ—¶é—´ååé‡=ç”¨æˆ·ä»£ç æ‰§è¡Œæ—¶é—´ç”¨æˆ·ä»£ç æ‰§è¡Œæ—¶é—´+åƒåœ¾å›æ”¶æ‰§è¡Œæ—¶é—´

å“åº”æ—¶é—´ï¼šSTWè¶ŠçŸ­ï¼Œå“åº”æ—¶é—´è¶Šå¥½

å¯¹ååé‡ã€å“åº”æ—¶é—´ã€QPSã€å¹¶å‘æ•°ç›¸å…³æ¦‚å¿µå¯ä»¥å‚è€ƒ:[ååé‡ï¼ˆTPSï¼‰ã€QPSã€å¹¶å‘æ•°ã€å“åº”æ—¶é—´ï¼ˆRTï¼‰æ¦‚å¿µ](https://www.cnblogs.com/Courage129/p/14386511.html)

æ‰€è°“è°ƒä¼˜ï¼Œé¦–å…ˆç¡®å®šè¿½æ±‚ä»€ä¹ˆ,æ˜¯ååé‡? è¿˜æ˜¯è¿½æ±‚å“åº”æ—¶é—´ï¼Ÿè¿˜æ˜¯åœ¨æ»¡è¶³ä¸€å®šçš„å“åº”æ—¶é—´çš„æƒ…å†µä¸‹ï¼Œè¦æ±‚è¾¾åˆ°å¤šå¤§çš„ååé‡,ç­‰ç­‰ã€‚ä¸€èˆ¬æƒ…å†µä¸‹è¿½æ±‚ååé‡çš„æœ‰ä»¥ä¸‹é¢†åŸŸ:ç§‘å­¦è®¡ç®—ã€æ•°æ®æŒ–æ˜ç­‰ã€‚ååé‡ä¼˜å…ˆçš„åƒåœ¾å¤„ç†å™¨ç»„åˆä¸€èˆ¬ä¸ºï¼šParallel Scavenge + Parallel Old ï¼ˆPS + POï¼‰ã€‚

è€Œè¿½æ±‚å“åº”æ—¶é—´çš„ä¸šåŠ¡æœ‰ï¼šç½‘ç«™ç›¸å…³ ï¼ˆJDK 1.8ä¹‹å G1,ä¹‹å‰å¯ä»¥ParNew + CMS + Serial Oldï¼‰

### ä»€ä¹ˆæ˜¯è°ƒä¼˜ï¼Ÿ

1. æ ¹æ®éœ€æ±‚è¿›è¡ŒJVMè§„åˆ’å’Œé¢„è°ƒä¼˜
2. ä¼˜åŒ–è¿è¡ŒJVMè¿è¡Œç¯å¢ƒï¼ˆæ…¢ï¼Œå¡é¡¿ï¼‰
3. è§£å†³JVMè¿è¡Œè¿‡ç¨‹ä¸­å‡ºç°çš„å„ç§é—®é¢˜(OOM)

### è°ƒä¼˜ä¹‹å‰çš„è§„åˆ’

- è°ƒä¼˜ï¼Œä»ä¸šåŠ¡åœºæ™¯å¼€å§‹ï¼Œæ²¡æœ‰ä¸šåŠ¡åœºæ™¯çš„è°ƒä¼˜éƒ½æ˜¯è€æµæ°“

- æ— ç›‘æ§ï¼ˆå‹åŠ›æµ‹è¯•ï¼Œèƒ½çœ‹åˆ°ç»“æœï¼‰ï¼Œä¸è°ƒä¼˜

- æ­¥éª¤ï¼š

  1. ç†Ÿæ‚‰ä¸šåŠ¡åœºæ™¯ï¼ˆæ²¡æœ‰æœ€å¥½çš„åƒåœ¾å›æ”¶å™¨ï¼Œåªæœ‰æœ€åˆé€‚çš„åƒåœ¾å›æ”¶å™¨ï¼‰

     1. å“åº”æ—¶é—´ã€åœé¡¿æ—¶é—´ [CMS G1 ZGC] ï¼ˆéœ€è¦ç»™ç”¨æˆ·ä½œå“åº”ï¼‰
     2. ååé‡ = ç”¨æˆ·æ—¶é—´ /( ç”¨æˆ·æ—¶é—´ + GCæ—¶é—´) [PS+PO]

  2. é€‰æ‹©å›æ”¶å™¨ç»„åˆ

  3. è®¡ç®—å†…å­˜éœ€æ±‚ï¼ˆç»éªŒå€¼ 1.5G 16Gï¼‰

  4. é€‰å®šCPUï¼ˆè¶Šé«˜è¶Šå¥½ï¼‰

  5. è®¾å®šå¹´ä»£å¤§å°ã€å‡çº§å¹´é¾„

  6. è®¾å®šæ—¥å¿—å‚æ•°

     1. 

        ```
        -Xloggc:/opt/xxx/logs/xxx-xxx-gc-%t.log 
        -XX:+UseGCLogFileRotation 
        -XX:NumberOfGCLogFiles=5 
        -XX:GCLogFileSize=20M 
        -XX:+PrintGCDetails 
        -XX:+PrintGCDateStamps 
        -XX:+PrintGCCause
        ```

        æ—¥å¿—å‚æ•°è§£é‡Šè¯´æ˜:

        > /opt/xxx/logs/xxx-xxx-gc-%t.log ä¸­XXXè¡¨ç¤ºè·¯å¾„,%tè¡¨ç¤ºæ—¶é—´æˆ³,æ„æ€æ˜¯ç»™æ—¥å¿—æ–‡ä»¶æ·»åŠ ä¸€ä¸ªæ—¶é—´æ ‡è®°,å¦‚æœä¸æ·»åŠ çš„è¯,ä¹Ÿå°±æ„å‘³ç€æ¯æ¬¡è™šæ‹Ÿæœºå¯åŠ¨éƒ½ä¼šä½¿ç”¨åŸæ¥çš„æ—¥å¿—å,é‚£ä¹ˆä¼šè¢«é‡å†™ã€‚
        >
        > Rotationä¸­æ–‡æ„æ€æ˜¯å¾ªç¯ã€è½®æµ,æ„å‘³ç€è¿™ä¸ªGCæ—¥å¿—ä¼šå¾ªç¯å†™
        >
        > GCLogFileSize=20M æŒ‡å®šä¸€ä¸ªæ—¥å¿—å¤§å°ä¸º20M,å¤ªå¤§äº†ä¸åˆ©äºåˆ†æ,å¤ªå°åˆä¼šäº§ç”Ÿè¿‡å¤šçš„æ—¥å¿—æ–‡ä»¶
        >
        > NumberOfGCLogFiles=5 : æŒ‡å®šç”Ÿæˆçš„æ—¥å¿—æ•°ç›®
        >
        > PrintGCDateStamps :PrintGCDateStampsä¼šæ‰“å°å…·ä½“çš„æ—¶é—´ï¼Œè€ŒPrintGCTimeStamps
        >
        > â€‹	ä¸»è¦æ‰“å°é’ˆå¯¹JVMå¯åŠ¨çš„æ—¶å€™çš„ç›¸å¯¹æ—¶é—´ï¼Œç›¸å¯¹æ¥è¯´å‰è€…æ›´æ¶ˆè€—å†…å­˜ã€‚

     2. æˆ–è€…æ¯å¤©äº§ç”Ÿä¸€ä¸ªæ—¥å¿—æ–‡ä»¶

  7. è§‚å¯Ÿæ—¥å¿—æƒ…å†µ
     æ—¥å¿—æœ‰åˆ†æå·¥å…·,å¯è§†åŒ–åˆ†æå·¥å…·æœ‰[GCeasy](https://gceasy.io/)å’Œ[GCViewer](https://github.com/chewiebug/GCViewer)ã€‚

     ### 